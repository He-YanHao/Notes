# DS18B20

## 流程概述

1.  **初始化**

    1.  **复位脉冲**：主设备将单总线拉低至少480微秒，然后释放（拉高）。这个长时间的拉低信号就是复位脉冲，相当于对所有挂在总线上的DS18B20喊一声“注意！”。
    2.  **存在脉冲**：DS18B20检测到总线被释放（从低变高）后，会等待15-60微秒，然后主动将总线拉低60-240微秒，作为回应。这个回应信号就是存在脉冲，相当于传感器回答“我在这里！”。
    3.  **主设备检测**：主设备在释放总线后会立即监测总线电平。如果检测到这个由从设备产生的低电平“存在脉冲”，就说明总线上有DS18B20设备，初始化成功。随后，DS18B20会释放总线，总线恢复到高电平的空闲状态。
    4.  **只有初始化成功，才能进行后续的通信。**

2.  **执行ROM命令**（用于识别和选择总线上的特定传感器）

    初始化成功后，主设备需要发送一条ROM命令。这些命令是针对传感器内部唯一64位ROM ID的操作，主要用于在单总线上有多个传感器时进行寻址。

    常用的ROM命令包括：

    *   **搜索ROM**：用于识别总线上所有DS18B20的ROM ID。这是在挂接多个传感器时必须使用的命令。
    *   **读取ROM**：当总线上只有一个DS18B20时，可以直接读取其ROM ID。
    *   **匹配ROM**：后跟一个64位的ROM ID，用于选中总线上一个特定的DS18B20。后续的功能命令将只发给这个设备。
    *   **跳过ROM**：当总线上只有一个DS18B20时，可以使用此命令跳过ROM寻址步骤，直接向总线上的所有设备（虽然只有一个）发送功能命令，以简化流程。

3.  **执行功能命令**（用于控制传感器执行特定操作，如启动温度转换、读取暂存器等）

    1.  在发送完ROM命令（通常是“跳过ROM”或“匹配ROM”）后，主设备会发送一条功能命令，告诉DS18B20要做什么。

        核心的功能命令包括：

        *   **启动温度转换**：发送此命令后，DS18B20会开始一次温度测量。转换时间与精度有关（例如，12位精度需要最多750毫秒）。在此期间，如果主设备读取总线，会读到“0”，表示忙；转换完成后再读会读到“1”。
        *   **读取暂存器**：此命令用于读取DS18B20内部暂存器的全部9个字节内容，包括温度值（前两个字节）、高低报警阈值和配置寄存器等。
        *   **写入暂存器**：此命令允许主设备向暂存器写入数据，例如设置报警阈值和配置传感器的分辨率。

4.  **数据交换**

    1.  在执行“读取暂存器”或“写入暂存器”等命令时，主设备需要与DS18B20进行实际的数据读写。单总线协议通过精确的时序来区分读写“0”和“1”。

        *   **写时序**：
            *   **写“1”**：主设备将总线拉低约1-15微秒，然后在整个时序周期（通常60微秒）内释放总线（拉高）。
            *   **写“0”**：主设备将总线拉低至少60微秒，然后释放。
            *   在每个写时序之后，DS18B20会在一个很短的窗口内采样总线电平，高电平则为“1”，低电平则为“0”。

        *   **读时序**：
            *   主设备发起读时序：将总线拉低至少1微秒，然后释放。
            *   DS18B20响应：如果它要输出“1”，则保持总线高电平；如果要输出“0”，则将总线拉低。
            *   主设备采样：在主设备拉低总线后约15微秒内，主设备读取总线当前电平。高电平为“1”，低电平为“0”。
            *   整个读时序周期应至少持续60微秒，之后总线被上拉电阻恢复为高电平。





### 完整工作流程示例（读取温度）

1.  **初始化**：主设备发送复位脉冲，并成功接收到DS18B20回应的存在脉冲。
2.  **ROM命令**：发送 **“跳过ROM”** 命令（假设总线上只有一个传感器）。
3.  **功能命令**：发送 **“启动温度转换”** 命令。
4.  **等待转换**：主设备等待足够的转换时间（例如750毫秒）。期间可以不断读取总线状态来判断是否完成。
5.  **再次初始化**：发送复位脉冲，并再次接收存在脉冲，开始新一轮通信。
6.  **ROM命令**：再次发送 **“跳过ROM”** 命令。
7.  **功能命令**：发送 **“读取暂存器”** 命令。
8.  **读取数据**：主设备执行连续的**读时序**，从DS18B20读取暂存器的前两个字节（即温度值）。
9.  **数据处理**：主设备将读取到的两个字节数据按照DS18B20的数据格式（二进制补码）组合，并转换成实际的温度值。

这个流程清晰地展示了如何在不依赖特定编程语言的情况下，通过操作单总线的电平时序来控制DS18B20并获取温度数据。