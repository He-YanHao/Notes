# SD卡命令

## 命令基础介绍

SD卡的寄存器只能通过对应的命令访问(CMD0-CMD63)，对SD卡进行控制操作并不是像操作控制器GPIO相关寄存器那样一次读写一个寄存器的，它是通过命令来控制。

SDIO定义了64个命令，每个命令都有特殊意义，可以实现某一特定功能，SD卡接收到命令后，根据命令要求对SD卡内部寄存器进行修改，程序控制中只需要发送组合命令就可以实现SD卡的控制以及读写操作。

>   并非每个型号的SD卡都支持所以64个命令，有些命令仅存在于特定型号的SD卡。



## 命令类型

SD命令由主机发出，以广播命令和寻址命令为例，广播命令是针对与SD主机总线连接的所有从设备发送的，寻址命令是指定某个地址设备进行命令传输。

SD命令有4种类型：

| 命令类型         |                                                              |      |      |      |      |
| ---------------- | ------------------------------------------------------------ | ---- | ---- | ---- | ---- |
| 无响应广播命令   | 发送到所有卡，不返回任务响应；                               |      |      |      |      |
| 带响应广播命令   | 发送到所有卡，同时接收来自所有卡响应，但 只有一个有效返回（物理上通过开漏仲裁）； |      |      |      |      |
| 寻址命令         | 发送到选定卡，DAT线无数据传输；                              |      |      |      |      |
| 寻址数据传输命令 | 发送到选定卡，DAT线有数据传输。                              |      |      |      |      |



## 命令格式

SD卡的命令固定为48位，由6个字节组成。

```
0X XX         XX         XX         XX         XX         XX;
0B 0000 0000  0000 0000  0000 0000  0000 0000  0000 0000  0000 0000;
```

- 字节1：
    - 字节1的最高位固定为0。
    - 第二高位为1时表示命令，方向为主机传输到SD卡，该位为0时表示响应，方向为SD卡传输到主机。
    - 低6位为命令号，共有64个命令(代号：CMD0~CMD63)，。
- 字节2~5为命令参数，有些命令是没有参数的。
- 字节6：
    - 字节6的高七位为CRC校验值，用于验证命令传输内容正确性，如果发生外部干扰导致传输数据个别位状态改变将导致校准失败，也意味着命令传输失败，SD卡不执行命令。
    - 最低位恒定为1。
    
    >   例如CMD16: 
    >
    >   ```
    >   0B (0)(1)(01 0000) (0000 0000 0000 0000 0000 0000 0000 0000) (0000 0001);
    >   ```



## 响应

SD卡共有七个响应类型（R1~R7）。

在主机发送有响应的命令后，SD卡都会给出相对应的应答，以告知主机该命令的执行情况，或者返回主机需要获取的数据。

与命令一样，SD卡的响应也是通过CMD线连续传输的。

SD的响应大体分为短响应48bit和长响应136bit，每个响应也有规定好的格式。R1、R1b、R3、R6和R7属于短响应，而R2属于长响应。

| 响应 | 长度   | 描述                                                         |
| ---- | ------ | ------------------------------------------------------------ |
| R1   | 48bit  | 正常响应，告知卡的状态。                                     |
| R1b  | 48bit  | 格式与R1相同，卡可能通过拉低DAT0线表示忙状态，直到操作完成。 |
| R2   | 136bit | 用于响应CMD2（请求CID）或CMD10（请求CSD），返回CID或CSD寄存器的值。 |
| R3   | 48bit  | 用于ACMD41命令（SD卡初始化命令），返回OCR（Operating Conditions Register）寄存器的值。 |
| R6   | 48bit  | 用于响应CMD3（发布相对卡地址RCA），返回新分配的RCA和卡状态。 |
| R7   | 48bit  | 用于响应CMD8命令（发送接口条件），返回电压信息和检查模式。   |

SD卡有多种命令和响应，发送命令时主机只能通过CMD引脚发送给SD卡，串行逐位发送时先发送最高位(MSB)，然后是次高位这样类推。



## 常用命令

### 标准命令（CMD）

| 命令  | 数据 | 参数             | 响应         | 作用                                                         | 操作背景                                                     |
| ----- | ---- | ---------------- | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| CMD0  | 0x00 | NONE             | R1           | 将 SD 卡置于空闲状态。用于初始化时，将卡重置到初始状态       | 卡刚插入后，需要通过 `CMD0` 进入空闲状态，然后才能进行后续的命令和初始化。 |
| CMD2  | 0x02 | NONE             | R2           | 获取 SD 卡的唯一识别号CID。CID 是一个 128-bit 的唯一标识符。 |                                                              |
| CMD3  | 0x03 | NONE             | R6           | 请求卡分配一个相对地址RCA。RCA 是主机和卡之间的通信地址。    | 主机用 RCA 来选择特定的卡进行通信。                          |
| CMD6  | 0x06 |                  |              | 切换卡的功能设置。用于切换卡的操作模式（如 1-bit 或 4-bit 数据传输模式等）。 | 通常用于更改卡的工作模式或切换特定功能。                     |
| CMD7  | 0x07 | RCA              | R1b          | 选择或取消选择一个卡。通过这个命令来选中当前的卡进行数据传输。 | 主机通过 `CMD7` 来选择当前工作卡，执行读取/写入操作。        |
| CMD8  | 0x08 | VHS+Checkpattern | 检查接口条件 | 检查 SD 卡是否符合特定的电压要求。用于初始化时，检查卡是否支持某些特定的电压范围。 | SD 卡规定了电压范围，主机通过此命令确认卡是否符合要求。      |
| CMD9  | 0x09 | RCA              | R2           | 读取卡的 CSD 寄存器。CSD（Card Specific Data）包含卡的特定信息，如最大块大小、卡类型等。 | 通过读取 CSD 信息，主机可以了解卡的能力和配置。              |
| CMD10 | 0x0A |                  |              | 读取卡的 CID 寄存器，获取卡的唯一身份信息。                  | CID 包含厂商 ID、产品型号、序列号等信息，是卡的唯一标识。    |
| CMD12 | 0x0C |                  |              | 停止当前的数据传输。                                         | 此命令用于在进行数据传输过程中，如果出现问题，提前中止数据传输。 |
| CMD13 | 0x0D | RCA              | R1           | 请求卡的状态信息                                             | 卡在执行命令时可能会处于忙状态，主机可通过此命令检查卡的状态。 |
| CMD15 |      |                  |              | 将卡置于非活动状态。                                         | 用于将卡置于不活跃状态。                                     |
| CMD16 | 0x10 | 块大小           | R1           | 设置块大小。                                                 | 设置块大小（单位字节），通常是 512 字节。                    |
| CMD17 | 0x11 | 地址             | R1           | 读取一个块的数据。                                           | 此命令用于从卡中读取一个数据块（通常为 512 字节）。          |
| CMD18 |      |                  |              | 读取多个数据块。                                             | 此命令用于从卡中读取多个数据块（通常为多个 512 字节块）。    |
| CMD24 | 0x18 | 地址             | R1           | 向卡写入一个数据块。                                         | 此命令用于向卡中写入单个数据块。                             |
| CMD25 |      |                  |              | 向卡写入多个数据块。                                         | 此命令用于向卡中写入多个数据块。                             |
| CMD27 |      |                  |              | 编程 CSD 寄存器。用于更改卡的一些特性（如卡的容量等）。      | 此命令用于修改 CSD 寄存器中的信息，但并不常用。              |
| CMD28 |      |                  |              | 设置写保护。                                                 | 用于对卡进行写保护设置，防止数据被修改。                     |
| CMD29 |      |                  |              | 清除写保护。                                                 | 用于解除卡的写保护。                                         |
| CMD30 |      |                  |              | 查询写保护状态。                                             | 用于查询卡的写保护状态。                                     |
| CMD32 |      |                  |              | 设置擦除起始块。                                             | 用于设置擦除操作的起始块。                                   |
| CMD33 |      |                  |              | 设置擦除结束块                                               | 用于设置擦除操作的结束块                                     |
| CMD38 |      |                  |              | 执行擦除操作                                                 |                                                              |
| CMD42 |      |                  |              | 锁定或解锁卡的保护区域                                       | 用于卡的保护区的管理。                                       |
| CMD55 | 0x37 | NONE             | R1           | 指示后续的命令是应用命令（ACMD）。必须在应用命令之前发送。   |                                                              |



### 应用命令（ACMD）

| 命令   | 数据 | 参数        | 响应 | 作用                                                        | 操作背景 |
| ------ | ---- | ----------- | ---- | ----------------------------------------------------------- | -------- |
| ACMD6  |      |             |      | 设置 SD 卡的数据总线宽度，支持 1 位或 4 位数据传输。        |          |
| ACMD13 |      |             |      | 查询 SD 卡的状态。                                          |          |
| ACMD22 |      |             |      | 查询卡的写入块数。                                          |          |
| ACMD23 |      |             |      | 设置写入块擦除计数。                                        |          |
| ACMD41 | 0x29 | HCS+VDD电压 | R3   | 主机发送容量支持信息和OCR寄存器内容<br />请求卡的操作条件。 |          |
| ACMD42 |      |             |      | 设置或清除卡检测功能。                                      |          |
| ACMD51 |      |             |      | 读取 SCR 寄存器，获取 SD 卡的特性。                         |          |

```
typedef enum
{
    SD_OUT_OF_RANGE = 0,                  /* 0*/ /*  */
    SD_ADDRESS_ERROR,                     /* 1*/ /*  */
    SD_BLOCK_LEN_ERROR,                   /* 2*/ /*  */
    SD_ERASE_SEQ_ERROR,                   /* 3*/ /*  */
    SD_ERASE_PARAM,                       /* 4*/ /*  */
    SD_WP_VIOLATION,                      /* 5*/ /*  */
    SD_LOCK_UNLOCK_FAILED,                /* 6*/ /*  */
    SD_COM_CRC_ERROR,                     /* 7*/ /*  */
    SD_ILLEGAL_COMMAND,                   /* 8*/ /* */
    SD_CARD_ECC_FAILED,                   /* 9*/ /*  */
    SD_CC_ERROR,                          /*10*/ /*  */
    SD_GENERAL_UNKNOWN_ERROR,             /*11*/ /*  */

} sd_error_enum;

```

