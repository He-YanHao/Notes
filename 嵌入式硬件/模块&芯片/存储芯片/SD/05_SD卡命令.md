# SD卡命令

SD卡的寄存器只能通过对应的命令访问(CMD0-CMD63)，对SD卡进行控制操作并不是像操作控制器GPIO相关寄存器那样一次读写一个寄存器的，它是通过命令来控制。

SDIO定义了64个命令，每个命令都有特殊意义，可以实现某一特定功能，SD卡接收到命令后，根据命令要求对SD卡内部寄存器进行修改，程序控制中只需要发送组合命令就可以实现SD卡的控制以及读写操作。

>   并非每个型号的SD卡都支持所以64个命令，有些命令仅存在于特定型号的SD卡。



### 命令类型与格式

SD命令由主机发出，以广播命令和寻址命令为例，广播命令是针对与SD主机总线连接的所有从设备发送的，寻址命令是指定某个地址设备进行命令传输。

SD命令有4种类型：

- 无响应广播命令(bc)，发送到所有卡，不返回任务响应；
- 带响应广播命令(bcr)，发送到所有卡，同时接收来自所有卡响应；
- 寻址命令(ac)，发送到选定卡，DAT线无数据传输；
- 寻址数据传输命令(adtc)，发送到选定卡，DAT线有数据传输。

SD卡的命令固定为48位，由6个字节组成。

```
0X XX XX XX XX XX XX;
0B 0000 0000  0000 0000  0000 0000  0000 0000  0000 0000  0000 0000;
```

- 字节1：
    - 字节1的最高位固定为0。
    - 第二高位为1时表示命令，方向为主机传输到SD卡，该位为0时表示响应，方向为SD卡传输到主机。
    - 低6位为命令号，共有64个命令(代号：CMD0~CMD63)，。
- 字节2~5为命令参数，有些命令是没有参数的。
- 字节6：
    - 字节6的高七位为CRC校验值，用于验证命令传输内容正确性，如果发生外部干扰导致传输数据个别位状态改变将导致校准失败，也意味着命令传输失败，SD卡不执行命令。
    - 最低位恒定为1。

> - 例如CMD16: 0B 0101 0000  0000 0000  0000 0000  0000 0000  0000 0000  0000 0000;

## 命令及相关



### 参数



### 响应

SD卡共有七个响应类型（R1~R7）。

在主机发送有响应的命令后，SD卡都会给出相对应的应答，以告知主机该命令的执行情况，或者返回主机需要获取的数据。

与命令一样，SD卡的响应也是通过CMD线连续传输的。

SD的响应大体分为短响应48bit和长响应136bit，每个响应也有规定好的格式。R1、R1b、R3、R6和R7属于短响应，而R2属于长响应。

| 响应 | 长度   | 描述                                                         |
| ---- | ------ | ------------------------------------------------------------ |
| R1   | 48bit  | 正常响应，告知卡的状态。                                     |
| R1b  | 48bit  | 格式与R1相同，卡可能通过拉低DAT0线表示忙状态，直到操作完成。 |
| R2   | 136bit | 用于响应CMD2（请求CID）或CMD10（请求CSD），返回CID或CSD寄存器的值。 |
| R3   | 48bit  | 用于ACMD41命令（SD卡初始化命令），返回OCR（Operating Conditions Register）寄存器的值。 |
| R6   | 48bit  | 用于响应CMD3（发布相对卡地址RCA），返回新分配的RCA和卡状态。 |
| R7   | 48bit  | 用于响应CMD8命令（发送接口条件），返回电压信息和检查模式。   |

SD卡有多种命令和响应，发送命令时主机只能通过CMD引脚发送给SD卡，串行逐位发送时先发送最高位(MSB)，然后是次高位这样类推。

### 具体命令

| 命令         | 参数             | 响应         | 描述                                |
| ------------ | ---------------- | ------------ | ----------------------------------- |
| CMD0(0X00)   | NONE             | R1           | 复位SD卡                            |
| CMD1(0X)     | NONE             | R1           | MMC卡的初始化命令                   |
| CMD2(0X02)   | NONE             | R2           | 读取SD卡的CID寄存器值               |
| CMD3(0X03)   | NONE             | R6           | 要求SD卡发布新的相对地址            |
| CMD7(0X07)   | RCA              | R1b          | 选中SD卡                            |
| CMD8(0X08)   | VHS+Checkpattern | 检查接口条件 | 发送接口状态命令                    |
| CMD9(0X09)   | RCA              | R2           | 获得选定卡的CSD寄存器的内容         |
| CMD13(0x0D)  | RCA              | R1           | 被选中的卡返回其状态                |
| CMD16(0X10)  | 块大小           | R1           | 设置块大小（字节数）                |
| CMD17(0X11)  | 地址             | R1           | 读取一个块的数据                    |
| CMD24(0X18)  | 地址             | R1           | 写入一个块的数据                    |
| CMD55(0X37)  | NONE             | R1           | 告诉SD卡，下一个是特定应用命令      |
| ACMD41(0X29) | HCS+VDD电压      | R3           | 主机发送容量支持信息和OCR寄存器内容 |

上表中，大部分的命令是初始化的时候用的。





