# SD卡初始化流程

SD 卡初始化的目的只有三点：

1.  **确认卡存在并能通信**
2.  **确认卡类型与能力**
3.  **把卡切换到“可数据传输状态”**

一切初始化步骤，都是围绕这三点展开。



1.  上电与时钟准备
2.  卡复位（Idle 状态）
3.  电压与版本协商
4.  容量与工作条件确认
5.  卡识别与参数读取
6.  数据传输模式建立



1.  SD 卡上电后：**需要一段稳定时间**

2.  **低速时钟**（通常 ≤ 400 kHz）**连续时钟脉冲**（即使不发命令）**初始化一定从低速开始，高速是后面的事**

3.  卡复位 让 SD 卡回到一个**已知的、标准的起始状态**。**任何一次初始化，第一件事一定是“复位卡”**

4.  电压与协议版本协商 **这一步决定了“地址怎么理解”，非常关键**

5.  工作条件确认（等待卡就绪）主控必须**轮询确认**

6.  卡识别与参数读取

    此阶段会读取：

    -   卡唯一 ID（序列号）
    -   制造商信息
    -   容量相关参数
    -   最大传输速度
    -   块大小能力

7.  进入数据传输模式 主控为 SD 卡分配一个通信地址 可以开始：

    -   块读
    -   块写
    -   多块操作
    -   提高时钟频率
    -   切换总线宽度（1bit → 4bit）
    -   配置 DMA / 中断 / 轮询模式
    -   挂载文件系统



## 初始化流程

```
CMD0 → CMD8 → CMD55 → ACMD41循环 → CMD2 → CMD3 → CMD7 → ACMD6 → 高速模式 → CMD16
CMD0 → CMD8 → CMD55 → ACMD41循环 → CMD2 → CMD3 → CMD7 → CMD9
// 精简后的正确流程：
CMD0  → 卡复位（进入空闲状态）
CMD8  → 验证电压范围，检测卡版本
循环：
  CMD55 → 应用命令前缀
  ACMD41 → 发送操作条件，等待卡就绪
结束循环后：
CMD2  → 获取CID
CMD3  → 获取相对地址(RCA)
// ... 后续其他命令
```

-   CMD0：初始化
-   CMD8：电压验证
-   ACMD41循环：
-   CMD2：
-   CMD3：
-   CMD7：
-   ACMD6：
-   高速模式：
-   CMD16：



1.  初始化GPIO口，配置好引脚复用。
2.  配置低速时钟，确保初始时钟频率在400kHz左右（SD卡规范要求）。
3.  设置SDIO电源状态为开启
4.  发送CMD0（GO_IDLE_STATE）：使SD卡进入空闲状态，命令参数为0，无响应。
5.  电压验证（可选）：发送CMD8（SEND_IF_COND）检查SD卡版本和电压兼容性，V2.0以上SD卡会响应
6.  **初始化过程** - 循环发送ACMD41（SD_APP_OP_COND）进行初始化：
    - 先发送CMD55（APP_CMD）表明下一个是应用特定命令
    - 再发送ACMD41带上HCS（高容量支持）位
    - 重复直到OCR寄存器中的忙位变为0，表示初始化完成
7.  **获取CID** - 发送CMD2（ALL_SEND_CID）获取卡的唯一标识符
8.  **获取相对地址** - 发送CMD3（SEND_RELATIVE_ADDR）获取SD卡分配的相对地址（RCA）
9.  **选择卡片** - 发送CMD7（SELECT_CARD）使用获取到的RCA选择该SD卡
10.  **设置总线宽度** - 通过ACMD6（SET_BUS_WIDTH）将数据总线从默认的1位切换到4位模式：
     - 先发送CMD55（APP_CMD）
     - 再发送ACMD6设置4位总线宽度
11.  **切换到高速模式** - 调用`SDIO_SwitchToHighSpeed()`函数：
     - 禁用SDIO时钟
     - 重新配置时钟分频器以获得更高频率
     - 重新使能时钟
     - 可能发送CMD6切换到高速传输模式（取决于卡类型）
12.  **设置块长度** - 发送CMD16（SET_BLOCKLEN）设置读写块大小为512字节
13.  **完成初始化** - 此时SD卡已准备好进行数据读写操作

