# FOC算法

**FOC** 全称 **Field-Oriented Control** 意为磁场定向控制。

FOC，也被称为矢量控制（Vector Control），是现代高性能电机控制（尤其是永磁同步电机PMSM和无刷直流电机BLDC）的基石。它彻底改变了交流电机的控制方式，使其能够像他励直流电机一样，实现精准的转矩和速度控制。

## 为什么需要FOC？

### 直流电机控制

**转矩公式**：`T = Kt * Φ * Ia`

- **T**： 电机输出的**电磁转矩**（Electromagnetic Torque），单位通常是牛顿·米（N·m）。
- **Kt**： **转矩常数**（Torque Constant），是电机的一个固有参数，取决于其物理结构（如线圈匝数、极对数等）。单位是 N·m / (A·Wb) 或更常见的 N·m/A（当 Φ 被视为常量时）。
- **Φ**： **每极磁通量**（Magnetic Flux per Pole），由定子侧的励磁系统产生，单位是韦伯（Wb）。
- **Ia**： **电枢电流**（Armature Current），流经电机转子（电枢）绕组的电流，单位是安培（A）。

通过独立控制`If`和`Ia`，就可以**完全解耦地控制磁场和转矩**，从而实现快速、平滑的转矩响应和精确的速度控制。

- **If**：**励磁电流**，是专门用于在直流电机中产生主磁场的电流。

### 交流电机与直流电机的不同

**交流电机（如PMSM/BLDC）的问题**：

* 交流电机的定子电流既是励磁电流又是转矩电流，它们耦合在一起。

* 转矩不仅取决于电流的大小，更取决于电流与转子永磁体磁场之间的**角度**。

    `T = Kt * I * sin(θ)`。

*   如果直接控制定子电流的幅度，转矩响应会非常不平顺（存在转矩脉动），效率低下，且在低速时控制性能很差。

**FOC的终极目标**：通过巧妙的数学变换，将交流电机中耦合的定子电流“分解”成两个独立的直流分量：一个用于产生磁场（**励磁分量 Id**），一个用于产生转矩（**转矩分量 Iq**）。然后像控制直流电机一样，分别独立地控制这两个分量。



## FOC算法的核心步骤与原理

FOC的处理流程可以概括为“**3个变换 + 1个控制**”的闭环系统。

### 第1步：克拉克(Clark)变换 (3相静止坐标系 → 2相静止坐标系)

* **坐标系**：**ABC坐标系** → **α-β坐标系** (Alpha-Beta)

* **目的**：将三相电流 `Ia, Ib, Ic` 从物理上相互依赖的120度坐标系，转换为数学上正交、独立的90度直角坐标系。这减少了变量的数量（3个变2个），简化了后续计算。

* **数学变换**：

    *   

    $$
    I_\alpha = I_a
    $$

    - 

    $$
    I_\beta = \frac{I_a + 2*I_b}{\sqrt{3}}
    $$

    > 为什么没有$I_b$？
    >
    > 因为在电机控制中通常假设三相电流是平衡的，即满足 $I_a+I_b+I_c=0$ 
    >
    > 这个条件允许我们通过 $I_a$ 和 $I_b$ 来表达 $I_c$ ，从而在变换公式中消除的显式 $I_c$ 出现。

* **克拉克(Clark)逆变换：**

    * $$
        I_a = I_\alpha
        $$

    * $$
        I_b = \frac{{\sqrt{3}}I_\beta - I_\alpha}{2}
        $$

    * $$
        I_c = \frac{- I_\alpha - {\sqrt{3}}I_\beta }{2}
        $$

* 计算过程：

    *   $I_a+I_b+I_c=0$，所以：$I_c=-I_a-I_b$
    *   选择让 $I_a$ 的方向与 $I_\alpha$ 的方向完全重合。
    *   $I_\beta$ 必须与 $I_\alpha$ 垂直。我们通常定义 $I_\beta$ 领先 $I_\alpha$ 90度。
    *   **$I_b$ 轴** 与 $I_\alpha$ 轴夹角为 **-120°**。
    *   **$I_c$ 轴** 与 $I_\alpha$ 轴夹角为 **120°**。
    *   可以得到这两个公式：
        *   $$I_\alpha = k \left[ I_a + (-\frac{1}{2}I_b) + (-\frac{1}{2}I_c) \right]$$
        *   $$I_\beta = k \left[ 0 + (-\frac{\sqrt{3}}{2}I_b) + (\frac{\sqrt{3}}{2}I_c) \right]$$
    *   带入 $I_c=-I_a-I_b$ 化简得到
        *   $$I_\alpha = k \left[ I_a -\frac{1}{2}I_b -\frac{1}{2}(-I_a - I_b) \right] = k \left[ I_a -\frac{1}{2}I_b + \frac{1}{2}I_a + \frac{1}{2}I_b \right] = k (\frac{3}{2}I_a)$$
        *   $$I_\beta = k \left[ -\frac{\sqrt{3}}{2}I_b + \frac{\sqrt{3}}{2}(-I_a - I_b) \right] = k \left[ -\frac{\sqrt{3}}{2}I_b -\frac{\sqrt{3}}{2}I_a -\frac{\sqrt{3}}{2}I_b \right] = k (-\frac{\sqrt{3}}{2}I_a - \sqrt{3}I_b)$$
    *   确定系数 $k$
        系数 $k$ 的选择有两种主流方式：
        *   **等幅值变换**：保证变换前后电流矢量的幅度不变。为了让 $I_\alpha$ 的系数变为 1，即 $k \cdot \frac{3}{2} = 1$，解得 $k = \frac{2}{3}$。
            代入上式可得：
            $$I_\alpha = I_a$$
            $$I_\beta = \frac{2}{3} \cdot (-\frac{\sqrt{3}}{2}I_a - \sqrt{3}I_b) = -\frac{\sqrt{3}}{3}I_a - \frac{2\sqrt{3}}{3}I_b = I_\beta = \frac{- I_a - 2*I_b}{\sqrt{3}}$$
        *   **等功率变换**：更常用。它保证变换前后的功率不变。经过计算，需要取 $k = \sqrt{\frac{2}{3}}$。

*   **物理意义**：`Iα` 和 `Iβ` 是两个正交的交流电流，它们的合成矢量 `Is` 代表了定子的电流磁场矢量在静止坐标系中的大小和方向。这个矢量在以固定的频率旋转。



### 第2步：帕克(Park)变换 (2相静止坐标系 → 2旋转坐标系)

*   **坐标系**：**α-β坐标系** → **d-q坐标系** (Direct-Quadrature)
*   **坐标系描述：**
    *   **α-β坐标系：** $\alpha$ 与 x 坐标重合；$\beta$ 与 y 坐标系重合；
    *   **d-q坐标系：** 与转子相关联，
*   **目的**：这是FOC的**灵魂所在**。它将静止的α-β坐标系中的交流量 `Iα` 和 `Iβ`，变换到与转子磁场同步旋转的d-q坐标系中，并转换为**直流量** `Id` 和 `Iq`。
*   **数学变换**：
    *   $I_d = I_\alpha * \cos({\theta}) + I_\beta * \sin({\theta})$
    *   $I_q = - I_\alpha * \sin({\theta}) + I_\beta * \cos({\theta})$
*   **逆变化：**
    *   $I_\alpha = I_d * \cos({\theta}) - I_q * \sin({\theta})$
    *   $I_\beta = I_q * \cos({\theta}) + I_d * \sin({\theta})$
*   公式中出现的变量含义：
    *   `Iα`: α轴电流分量
    *   `Iβ`: β轴电流分量
    *   `θ`: $I_q$−$I_d$ 坐标系因转动而造成的与 $I_α$ − $I_β$ 坐标系的差角θ，就被称为电角度！**这是关键！** 这个角度通常由编码器实时提供。
    *   `Id`: 直轴（Direct-axis）电流。这个电流产生的磁场与转子永磁体的磁场**方向平行**，主要用于**增磁或弱磁**。
    *   `Iq`: 交轴（Quadrature-axis）电流。这个电流产生的磁场与转子永磁体的磁场**方向垂直**，是**唯一产生转矩**的电流分量。
*   **物理意义**：
    *   **`Id` (励磁电流)**：其方向与转子永磁场平行（d轴），是**产生磁场**的分量。对于表面式永磁同步电机（SPMSM），通常将其设置为 **0**，因为永磁体已经提供了足够的磁场，额外的`Id`只会增加损耗甚至产生反作用。对于内置式永磁同步电机（IPMSM），可以利用 `Id` 进行弱磁扩速。
    *   **`Iq` (转矩电流)**：其方向与转子永磁场正交（q轴），是**产生转矩**的有效分量。控制 `Iq` 就等同于控制直流电机的电枢电流 `Ia`。
    *   由于坐标系随转子同步旋转，即使 `Is` 矢量本身是交流旋转的，它在d-q坐标系下的投影 `Id` 和 `Iq` 也变成了**直流量**。

### 第3步：电流环控制 (PI控制器)

*   **目的**：现在我们有了一对直流量 `Id` 和 `Iq`，就可以像控制直流电机一样，使用简单的PI控制器对它们进行独立、精确的控制。
*   **过程**：
    1.  给定参考值 `Iq_ref`（来自速度环或转矩指令）和 `Id_ref`（通常为0）。
    2.  将测量计算得到的 `Id`, `Iq` 与它们的参考值 `Id_ref`, `Iq_ref` 进行比较，得到误差。
    3.  误差信号经过PI控制器计算，输出在旋转d-q坐标系下需要补偿的电压值 `Vd` 和 `Vq`。

### 第4步：逆Park变换 (2旋转坐标系 → 2相静止坐标系)

*   **坐标系**：**d-q坐标系** → **α-β坐标系**
*   **目的**：将PI控制器输出的旋转坐标系下的直流电压控制量 `Vd` 和 `Vq`，重新转换回静止的α-β坐标系下的交流电压指令 `Vα` 和 `Vβ`。
*   **数学变换**：（使用同样的转子角度 `θ`）
    *   `Vα = Vd * cos(θ) - Vq * sin(θ)`
    *   `Vβ = Vd * sin(θ) + Vq * cos(θ)`

### 第5步：SVPWM (空间矢量脉宽调制)

*   **目的**：根据逆Park变换得到的电压矢量 `(Vα, Vβ)`，计算出逆变器（如三相全桥）中六个功率开关管（MOSFET/IGBT）的开关时间和顺序，以生成所需的三相正弦波电压。
*   **原理**：SVPWM将整个圆周分为6个扇区，通过组合逆变器8种基本开关状态（6个有效矢量，2个零矢量），用PWM波“合成”出任意角度和大小的电压矢量。相比传统的SPWM，SVPWM具有：
    *   **更高的直流母线电压利用率**（高出约15%）。
    *   **更低的谐波失真和开关损耗**。
    *   **更平滑的磁场旋转**。

至此，一个完整的FOC闭环结束。整个过程在每个PWM周期（通常几十微秒）内快速完成，使得电机电流能够紧紧跟随指令，实现高性能控制。



## FOC的关键技术与变种

1.  **无传感器FOC (Sensorless FOC)**：
    *   很多应用为了降低成本和提高可靠性，不希望使用物理编码器。
    *   无传感器FOC通过检测电机反电动势（Back-EMF）来估算转子位置和速度。
    *   在高速时估算精度很高，但在**启动和极低速**时，因为反电动势信号很弱，估算非常困难，是技术难点。常用的算法有滑模观测器（SMO）、模型参考自适应系统（MRAS）、龙贝格观测器、高频注入（HFI）等。

2.  **参数整定**：
    *   FOC系统的性能高度依赖PI控制器的参数（Kp, Ki）。
    *   需要同时对电流环（内环）和速度环（外环）进行整定。电流环要求响应极快（带宽高），速度环则相对慢一些。



## 电气角度与机械角度的关系

- **机械角度 (Mechanical Angle)**
- **定义**： 电机转子**实际物理旋转的角度**。这是一个几何概念。
    - **范围**： 转子转一圈，机械角度变化 360°。
    - **测量**： 用一个普通的编码器可以直接测量。
- **电角度 (Electrical Angle)**
    - **定义**： 从电磁场变化的角度来看的**角度**。它衡量的是磁场周期的变化。
    - **范围**： 转子转一圈，电角度变化 `360° × 极对数 (P)`。
    - **公式**： `电角度 (θ_elec) = 机械角度 (θ_mech) × 极对数 (P)`
    - **例子**： 一个4极电机（极对数 P=2），转子物理转一圈（机械360°），内部的磁场变化了**两个完整的周期**，因此电角度走了 720°。

针对n极对的数的无刷电机，机械角度 $\theta$ 每走 $\frac{360°}{n}$ ，电气角度 $\theta$ 就走360°

## 什么是对齐？(What is Alignment?)

在FOC中，**“对齐”指的是：让dq旋转坐标系的d轴，与转子永磁体产生的磁场轴线（N极和S极的连线）在物理上完全重合。**

- **d轴 (直轴)**： 在我们定义的dq坐标系中，d轴的方向就是转子磁场的轴线方向。
- **转子磁场轴线**： 是转子永磁体本身固有的物理属性。

所谓 **“对齐”**，就是确保控制器**“认为的”d轴方向**和**“物理真实的”转子磁场方向**是同一个方向。



### 为什么必须对齐？

如果不对齐，FOC的整个控制基础就会崩塌。

根据转矩公式：`T = Kt × Ψf × Iq`，我们希望通过控制 `Iq` 来线性地控制转矩。这个公式成立的一个**绝对前提**是：`Iq` 产生的磁场必须严格与转子磁场（Ψf）垂直（即90°电角度）。

**理想情况（已对齐）**：

- d轴与转子磁场重合。
- 我们注入 `Iq` 电流，它产生的磁场正好与d轴（转子磁场）垂直，产生**最大转矩**。此时 `Id=0`，效率最高。

**未对齐情况（存在偏差角 Δθ）**：

- 假设偏差了 Δθ 电角度。
- 你希望注入一个纯转矩电流 `Iq`。
- 但从转子磁场的视角看，你注入的电流矢量可以被分解为：
    - `Id_real = Iq × sin(Δθ)` （一个你不希望有的励磁分量）
    - `Iq_real = Iq × cos(Δθ)` （一个被削弱了的转矩分量）

**后果**：

- **转矩输出不准确**： 实际转矩 `T ∝ Iq_real` 小于你的预期。
- **效率降低、发热**： 产生了额外的 `Id_real` 电流，这部分电流不做功，只会导致电机发热和能源浪费。
- **控制性能下降**： 转矩响应非线性和滞后，动态性能变差。



## FOC的优势与挑战

### 优势：
*   **卓越的性能**：平滑的转矩控制，极低的转矩脉动，特别是在低速时。
*   **高效率和宽调速范围**：在全速度区间内都能保持高效率，动态响应快。
*   **安静噪音低**：平滑的磁场旋转和正弦波驱动使得电机运行非常安静。
*   **快速动态响应**：转矩控制带宽高，能迅速响应负载变化和速度指令。

### 挑战：
*   **计算复杂度高**：需要实时进行多个坐标变换和PI运算，对处理器的算力有要求（通常需要32位MCU，如STM32的Cortex-M系列，并配有硬件FPU和三角函数加速单元）。
*   **依赖电机参数**：控制精度依赖于准确的电机参数（电阻、电感、磁链等），参数变化会影响性能。
*   **需要位置信息**：要么需要昂贵的编码器，要么需要复杂算法的无传感器观测器。
*   **调试复杂**：需要整定多个PI参数，对工程师的理论知识和调试经验要求较高。



## 应用领域

FOC已成为中高端电机应用的标配：
*   **工业**：数控机床、机器人关节、精密传送带、离心机。
*   **消费电子**：无人机电调、家用电器（高端空调、洗衣机、风扇）、电脑散热风扇。
*   **汽车**：电动助力转向（EPS）、电子水泵、油泵、风扇、电动汽车的主驱动。
*   **航空航天**：飞控舵机、泵类驱动。

