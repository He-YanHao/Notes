四次挥手（Four-Way Handshake）是 **TCP 连接断开** 的过程，用来确保双方都能够正常关闭连接。通过四次交换信息，双方都确认数据已经完全传输并准备好关闭连接。

------

# 一句话理解

> 四次挥手的目的是：
> 确保双方都完成数据传输，可靠地关闭连接。

------

# 四次挥手过程

假设：

- 客户端（Client）
- 服务器（Server）

------

## 第一次挥手

客户端 → 服务器

发送：

```
FIN = 1
seq = x
```

含义：

- 客户端想关闭连接，发送一个 **FIN** 包
- 客户端告诉服务器：我已经没有数据要发送了

此时客户端状态：

```
FIN_WAIT_1
```

------

## 第二次挥手

服务器 → 客户端

发送：

```
ACK = 1
ack = x + 1
```

含义：

- 服务器确认收到客户端的 **FIN** 包
- 告诉客户端：我已经准备好关闭连接了，但我可能仍然有数据需要发送

此时服务器状态：

```
CLOSE_WAIT
```

客户端状态：

```
FIN_WAIT_2
```

------

## 第三次挥手

服务器 → 客户端

发送：

```
FIN = 1
seq = y
```

含义：

- 服务器告诉客户端：我已经没有数据要发送了，也准备关闭连接了

此时服务器状态：

```
LAST_ACK
```

客户端状态：

```
TIME_WAIT
```

------

## 第四次挥手

客户端 → 服务器

发送：

```
ACK = 1
ack = y + 1
```

含义：

- 客户端确认收到服务器的 **FIN** 包

此时，客户端状态：

```
CLOSED
```

服务器状态：

```
CLOSED
```

连接彻底关闭。

------

# 为什么是四次？

- **第一次挥手**：客户端发起关闭连接，表示它的数据已经发送完毕。
- **第二次挥手**：服务器确认客户端的关闭请求，告诉客户端它可以关闭，但可能还有数据要发送。
- **第三次挥手**：服务器向客户端发送关闭请求，告诉客户端它也没有数据要发送了。
- **第四次挥手**：客户端确认收到服务器的关闭请求，表示双方都已经完成数据传输，可以完全关闭连接。

------

# 四次挥手的特点

- **双向关闭**：四次挥手中每一方都需要单独关闭自己的一方向对方发送 **FIN**，保证双方都能安全关闭连接。
- **TCP 的半关闭状态**：客户端首先关闭了自己到服务器的方向，但服务器可能还会发送数据；然后服务器关闭连接前，客户端接收完数据后再关闭。这样，双方可以在不同的时间点完成数据发送和接收，避免丢失数据。

------

# 简单类比

就像挂电话：

1️⃣ 你：喂，我要挂了。
2️⃣ 对方：好，挂吧。
3️⃣ 对方：我也挂了。
4️⃣ 你：好的，我收到，你挂了，我也挂。

------

# 四次挥手的作用

- 确保双方都完成数据传输，避免丢失数据。
- 保证连接的可靠关闭。
- 避免服务器资源被浪费，防止僵尸连接。

------

# 总结

> 四次挥手是 TCP 断开连接的过程，通过 **FIN** 和 **ACK** 包确保双方都完成数据传输并可靠关闭连接。

------

如果你愿意，我可以继续讲：

- **TIME_WAIT** 状态的作用是什么？
- 四次挥手中的 **半关闭** 状态具体是什么意思？
- 从抓包角度分析四次挥手
- 四次挥手中的攻击方式（如 TCP RST 攻击）

你想进一步了解哪部分？
