# CAN帧格式

## 数据位

CAN总线采用差分信号，即两线电压差（CAN_H - CAN_L）传输数据位。

**高速CAN规定：**

- 电压差为0V时表示逻辑1（隐性电平）。此时CAN_H和CAN_L都为2.5V。
- 电压差为2V时表示逻辑0（显性电平）。此时CAN_H为3.5V，CAN_L为1.5V。

**低速CAN规定：**

- 电压差为-1.5V时表示逻辑1（隐性电平）。此时CAN_H为1.75V，CAN_L为3.25V。
- 电压差为3V时表示逻辑0（显性电平）。此时CAN_H为4V，CAN_L为1V。

在CAN中，发送逻辑0显性电平需要设备主动改变电位差，发送逻辑1隐性电平只需要放开就行。

总线上执行逻辑上的线“与”时， 显性电平为“0”，隐性电平为“1”。

显性电平和隐性电平二者必居其一。发送方通过使总线电平发生变化，将消息发送给接收方。



## 位填充规则

发送方每发送5个相同电平后，自动追加一个相反电平的填充位， 接收方检测到填充位时，会自动移除填充位，恢复原始数据。



## 数据格式

| 帧类型 | 用途                                   |
| ------ | -------------------------------------- |
| 数据帧 | 发送设备主动发送数据（广播式）         |
| 遥控帧 | 接收设备主动请求数据（请求式）         |
| 错误帧 | 某个设备检测出错误时向其他设备通知错误 |
| 过载帧 | 接收设备通知其尚未做好接收准备         |
| 帧间隔 | 用于将数据帧及遥控帧与前面的帧分离开   |

### 数据帧

**数据帧各部分用途简介：**

- 帧起始：

    - SOF（Start of Frame）：帧起始，是一个显性位 (0)，标志着一个帧的开始，并用于总线节点的同步。

- 仲裁段：分为标准格式和扩展格式。

    - 标准格式：

        - ID（Identify）：标识符，区分功能，同时决定优先级。

            > 有 11 个位。从 ID28 到 ID18 被依次发送。禁止高 7 位都为隐性。（禁止设定：ID=1111111XXXX）。

        - RTR（Remote Transmission Request ）：远程请求位，区分数据帧和遥控帧。

            数据帧RTR为显性电平 0。

        - IDE（Identifier Extension）：扩展标志位，区分标准格式和扩展格式。

            IDE位为显性电平 0，表示数据帧为标准格式；

            IDE位为隐性电平 1，表示数据帧为扩展帧格式；

    - 扩展格式：

        - 基本 ID（Identify）：扩展格式ID的 ID28 到 ID18。为标识符，区分功能，同时决定优先级。

            > 有 29 个位。基本 ID 从 ID28 到 ID18，扩展 ID 由 ID17 到 ID0 表示。基本 ID 和 标准格式的 ID 相同。禁止高 7 位都为隐性。（禁止设定：基本 ID=1111111XXXX）。

        - SRR（Substitute Remote Request）：替代标准格式的RTR，在标准帧与扩展帧发生仲裁竞争时，确保标准帧（其RTR位可能是显性0）优先级高于具有相同基本ID的扩展帧（其SRR位是隐性1）。永远置隐性电平 1。

        - IDE（Identifier Extension）：扩展标志位，区分标准格式和扩展格式。

            IDE位为显性电平 0，表示数据帧为标准格式；

            IDE位为隐性电平 1，表示数据帧为扩展帧格式；
        
        - 扩展 ID：扩展格式ID的 ID17 到 ID0。为标识符，区分功能，同时决定优先级。
        
        - RTR（Remote Transmission Request ）：远程请求位，区分数据帧和遥控帧。
        
            数据帧RTR为显性电平 0。
        
        - IDE（Identifier Extension）：扩展标志位，区分标准格式和扩展格式。
        
            IDE位为显性电平 0，表示数据帧为标准格式；
        
            IDE位为隐性电平 1，表示数据帧为扩展帧格式；

- 控制段：固定为六位。

    - r1保留位：此r1与仲裁段的SRR位完全不同！

        在经典CAN协议中，此位为保留位。必须发送**显性位(0)**，接收器忽略其值。

        在 CAN FD 协议中，此位被重新定义为 FDF (FD Frame) 位，用于区分经典CAN帧和CAN FD帧。

    - r0保留位：必须发送显性位(0)，接收器忽略其值。

    - DLC (Data Length Code)：指示接下来的的数据段的长度，本身有四位，用二进制的方式指示数据段有几个字节。

- 数据段：

    - Data：数据段的1~8个字节有效数据。从 MSB（最高位）开始输出。

- CRC段：循环冗余校验，校验数据是否正确，包含16位。CRC 的计算范围包括帧起始、仲裁段、控制段、数据段。

    - CRC数据段：15 位，进行CRC校验。
    - CRC界定符：为应答位前后发送方和接收方释放总线留下时间。显性电平 0。

- ACK段：应答位，判断数据有没有被接收方接收。

    - ACK 槽(ACK Slot)：发送方在此位置发送隐性位(1)。任何正确接收到有效帧（无错误）的接收方，应在此槽位期间发送一个显性位(0) 进行应答。如果发送方在ACK槽内检测到的仍是隐性位，则表明无节点正确接收，将触发应答错误。
    - ACK 界定符：为应答位前后发送方和接收方释放总线留下时间。

- 帧结束：

    - EOF（End of Frame ）：帧结束，表示数据位已经传输完毕。由 7 个位的隐性位构成。



### 遥控帧

遥控帧用于请求具有相同ID的数据帧。

其RTR位为隐性电平(1)，且其数据段为空（不包含有效数据），但其DLC码指明所请求数据帧的数据长度。



### 错误帧

总线上所有设备都会监督总线的数据，一旦发现 “ 位错误 ” 或 “ 填充错误 ” 或 “ CRC 错误 ” 或 “ 格式错误 ” 或 “ 应答错误 ” ，这些设备便会发出错误帧来破坏数据，同时终止当前的发送设备。

错误帧由**错误标志**和**错误界定符**组成。

- **主动错误标志**：由处于主动错误状态的节点发出，为**6个连续的显性位**。
- **被动错误标志**：由处于被动错误状态的节点发出，为**6个连续的隐性位**。
- **错误界定符**：由**8个连续的隐性位**组成。



### 过载帧

当接收方收到大量数据而无法处理时，其可以发出过载帧，延缓发送方的数据发送，以平衡总线负载，避免数据丢失。

过载帧包含 6 个显性0，



### 帧间隔

将数据帧和遥控帧与前面的帧分离开。
