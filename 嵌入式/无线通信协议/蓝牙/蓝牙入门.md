# 蓝牙入门

## 蓝牙协议分类

蓝牙协议种类极多，极其复杂。

包含：

-   **商业/闭源协议栈**
    -   **Cypress/Infineon WICED**：面向IoT设备的成熟协议栈
    -   **Silicon Labs Gecko SDK**：包含自家的蓝牙协议栈
    -   **Microchip Harmony BLE**：针对PIC32等MCU
    -   **STMicroelectronics STM32Cube**：集成BlueNRG协议栈
    -   **Realtek RTL蓝牙栈**：常用于Wi-Fi+蓝牙Combo芯片

-   **开源协议栈**
    -   **Zephyr BLE Host**：Linux基金会Zephyr RTOS的一部分，支持多种架构
    -   **BlueZ**：**Linux官方的蓝牙协议栈**，运行在桌面/服务器Linux上
    -   **Fluoride**：Android系统底层的蓝牙协议栈（Bluedroid在其之上）
    -   **BlueKitchen BTStack**：非常流行的开源嵌入式蓝牙协议栈，支持多种平台

-   **芯片厂商自有协议栈**
    -   **Nordic SoftDevice/nRF5 SDK/nRF Connect SDK**：蓝牙领域的黄金标准
    -   **TI BLE-Stack**：用于CC26xx/CC13xx系列
    -   **Dialog SmartBond SDK**：用于DA145xx系列
    -   **Telink TLSR SDK**：用于超低成本的Telink芯片

**ESP-IDF** 支持两种主机协议栈：**Bluedroid** 和 **NimBLE**。

-   **Bluedroid** （默认协议栈）：支持经典蓝牙和低功耗蓝牙，适用于同时使用这两种技术的应用场景。
-   **NimBLE**：仅支持低功耗蓝牙，因代码体积小、内存占用低，适合资源受限的应用。



## 协议分层

低功耗蓝牙协议定义了三层软件结构，自上而下分别是

-   应用层 (Application Layer)
    -   具体的调用代码，决定了蓝牙在什么情况下工作。
-   主机层 (Host Layer)
    -   主机实现应用交互所需的高层协议，包含：
    -   L2CAP (逻辑链路控制与适配协议): 处理数据分段、重组和复用。
    -   SMP (安全管理协议): 管理身份验证、加密和安全配对。
    -   GAP (通用访问规范): 管理设备发现、连接建立，并定义蓝牙设备的角色和模式。
    -   ATT/GATT (属性协议/通用属性规范): 通过服务和特征实现基于属性的数据交换，主要用于低功耗蓝牙。
    -   SDP (服务发现协议): 允许设备广播和发现可用服务，主要用于经典蓝牙。
-   控制器层 (Controller Layer)
    -   PHY (物理层): 处理 2.4 GHz ISM 频段的蓝牙信号收发。
    -   基带 (Baseband): 管理底层时序和控制功能，包括跳频、数据包格式化和纠错。
    -   链路控制器 (Link Controller): 处理设备连接/断开的链路状态机、流控和重传机制。
    -   链路管理器 (Link Manager): 管理链路设置、身份验证、加密和功率控制。
    -   设备管理器 (Device Manager): 管理设备状态，处理寻呼/查询流程，存储安全密钥。



应用层即以低功耗蓝牙为底层通信技术所构建的应用，依赖于主机层向上提供的 API 接口。

主机层负责实现 L2CAP、GATT/ATT、SMP、GAP 等底层蓝牙协议，向上对应用层提供 API 接口，向下通过主机控制器接口 (Host Controller Interface, HCI) 与控制器层通信。

控制器层包括物理层 (Physical Layer, PHY) 和链路层 (Link Layer, LL) 两层，向下直接与控制器硬件进行交互，向上通过 HCI 与主机层进行通信。




