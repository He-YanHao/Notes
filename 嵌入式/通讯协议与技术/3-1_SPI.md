# SPI

## 通讯连接线

SPI 通讯使用3条总线及片选线，3条总线分别为SCK、MOSI、MISO，片选线为SS，它们的作用介绍如下：

* SCK(Serial Clock) ：时钟信号线，用于通讯数据同步。它由通讯主机产生，决定了通讯的速率，不同的设备支持的最高时钟频率不一样，如STM32的SPI时钟频率最大为fpclk/2，两个设备之间通讯时，通讯速率受限于低速设备。

* MOSI(Master Output，Slave Input) ：主设备输出/从设备输入引脚。主机的数据从这条信号线输出，从机由这条信号线读入主机发送的数据，即这条线上数据的方向为主机到从机。

* MISO(Master Input,，Slave Output) ：主设备输入/从设备输出引脚。主机从这条信线读入数据， 从机的数据由这条信号线输出到主机，即在这条线上数据的方向为从机到主机。

* SS(Slave Select)：从设备选择信号线，或片选信号线，也称为NSS、CS。当有多个SPI从设备与SPI主机相连时，设备的其它信号线SCK、MOSI及MISO同时并 联到相同的SPI总线上，即无论有多少个从设备，都共同只使用这3条总线；而每个从设备都有独立的这一条NSS信号线，本信号线独占主机的一个引脚，即有多少个从设备，就 有多少条片选信号线。

  > SPI通信没有设备地址，通过SS线确定，当主机要选择从设备时， 把该从设备的SS信号线设置为低电平，该从设备即被选中，即片选有效，所以SS默认高电平，接着主机开始与被选中的从设备进行SPI通讯。所以SPI通讯以SS线置低电平为开始信号，以SS线 被拉高作为结束信号。



## SPI模式

MISO初始化为上拉输入，其余初始化为推挽输出。

SPI交换一个字节有四种模式，由空闲状态时SCK的电平和移入数据移出数据相对于SCK的时机共同决定。

0. SPI模式0：CPOL=0：空闲状态时，SCK为低电平；	CPHA=0：SCK第一个边沿移入数据，第二个边沿移出数据，数据在上升沿采样；
1. SPI模式1：CPOL=0：空闲状态时，SCK为低电平；	CPHA=1：SCK第一个边沿移出数据，第二个边沿移入数据，数据在下降沿采样；
2. SPI模式2：CPOL=1：空闲状态时，SCK为高电平；	CPHA=0：SCK第一个边沿移入数据，第二个边沿移出数据，数据在上升沿采样；
3. SPI模式3：CPOL=1：空闲状态时，SCK为高电平；	CPHA=1：SCK第一个边沿移出数据，第二个边沿移入数据，数据在下降沿采样；

**针对CPOL和CPHA的理解：**

CPOL就是 SPI 不进行通讯时也就是发送前和发送后的状态。

CPHA中的边沿可以理解为变化，比如：

-   SCK默认低时，第一个边沿时从低变高的过程，第二个边沿从高变低的过程；

-   SCK默认高时，第一个边沿时从高变低的过程，第二个边沿从低变高的过程；

移出数据就是写入数据，移入数据就是读取数据；



SPI是全双工的：读和写是同时进行的，不存在"先读"或"先写"的概念。在每个时钟周期内，主机和从机同时发送和接收数据。

准确的说法是"数据采样时刻"：关键的区别在于数据在时钟的哪个边沿被采样，以及在哪个边沿可以变化。



## SPI时序

初始SCK、MOSI、MISO、SS均为高。

SS拉低作为SPI的开始。

这时候



