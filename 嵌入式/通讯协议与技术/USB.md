# USB

## 接口标准

### USB Type-A

就是最常见的USB接口。

共有四个引脚，其母头引脚引出为：

| 引脚名称           | 作用                                           | 导线颜色 |
| ------------------ | ---------------------------------------------- | -------- |
| VCC/5V             | 正极                                           | 红色     |
| D- / -3.3V         | 数据负                                         | 白色     |
| D+ / +3.3V         | 数据正                                         | 绿色     |
| ID（仅限 USB OTG） | A型：与地相连；B型：不接地(空)；用来判断主从； |          |
| GND                | 接地                                           | 黑色     |

USB Type-A同时有一个 9 线的版本。

| 符号       | 符号名称               | 功能     |
| ---------- | ---------------------- | -------- |
| VBUS       | 电源                   | 提供电源 |
| D-         | 数据传输端负           | 传输数据 |
| D+         | 数据传输端正           | 传输数据 |
| GND        | 地线                   |          |
| STDA_SSRX- | 超高速接收机差分对RX-  | 传输数据 |
| STDA_SSRX+ | 超高速接收机差分对RX+  | 传输数据 |
| GND_DRAIN  | 信号地                 |          |
| STDA_SSTX- | 超高速发射机差分对 TX- | 传输数据 |
| STDA_SSTX+ | 超高速发射机差分对 TX+ | 传输数据 |

### USB Type-B

使用较少，接口为方形，分为 4 线和 5 线版本。其引脚与USB Type-A只是排列上不同。

### Mini USB

USB Type-A和USB Type-B的缩小化。其引脚与USB Type-A只是排列上不同。

### Micro USB

安卓手机过去常用接口。其引脚与USB Type-A只是排列上不同。

### USB Type-C

插座引出引脚分布：

| 引脚 | 信号名称 | 功能描述                       | 引脚 | 信号名称 | 功能描述                       |
| ---- | -------- | ------------------------------ | ---- | -------- | ------------------------------ |
| A1   | GND      | 地线                           | B12  | GND      | 地线                           |
| A2   | SSTXp1   | SuperSpeed发送差分对+ (Lane 1) | B11  | SSTXp2   | SuperSpeed发送差分对+ (Lane 2) |
| A3   | SSTXn1   | SuperSpeed发送差分对- (Lane 1) | B10  | SSTXn2   | SuperSpeed发送差分对- (Lane 2) |
| A4   | VBUS     | 电源总线                       | B9   | VBUS     | 电源总线                       |
| A5   | CC1      | 配置通道1 (检测插入方向)       | B8   | CC2      | 配置通道2 (检测插入方向)       |
| A6   | Dp1      | USB 2.0差分对+ (Lane 1)        | B7   | Dp2      | USB 2.0差分对+ (Lane 2)        |
| A7   | Dn1      | USB 2.0差分对- (Lane 1)        | B6   | Dn2      | USB 2.0差分对- (Lane 2)        |
| A8   | SBU1     | 边带使用1                      | B5   | SBU2     | 边带使用2                      |
| A9   | VBUS     | 电源总线                       | B4   | VBUS     | 电源总线                       |
| A10  | SSRXn1   | SuperSpeed接收差分对- (Lane 1) | B3   | SSRXn2   | SuperSpeed接收差分对- (Lane 2) |
| A11  | SSRXp1   | SuperSpeed接收差分对+ (Lane 1) | B2   | SSRXp2   | SuperSpeed接收差分对+ (Lane 2) |
| A12  | GND      | 地线                           | B1   | GND      | 地线                           |



## 协议

### 协议分类



**USB速度包含：**

- 低俗模式：1.5 Mb/s
- 全速模式：12 Mb/s
- 高速模式：480 Mb/s



### 初始化

协议规定每个USB设备使用一个7bit的地址，其中地址 0 供给未初始化的设备，剩下127个地址，所以一个USB主控制器最多可以连接127个USB设备。



主机 D+ D- 接15KΩ下拉电阻，从机 D+ 或 D- 连接上拉1.5KΩ电阻到3.3V(低速USB接到D-上，全速和高速USB接到D+上)，双方通过电平变化就可以发现USB的拔插事件。

主机悬空时 D+ D- 被接的15KΩ下拉电阻拉到低电平，

USB设备插入后从机上拉电阻将主机对应管脚拉高到3V左右，主机从而判断从机插入。然后根据 D+ 或 D- 被拉高判断主机接入的是USB低速 全速 高速设备，若是 D- 被拉高则是低速设备，若是 D+ 被拉高则是全速设备，高速设备先识别为全速设备再通过一系列的数据交换被识别为高速设备。若为高速模式，则是电流传输，断开 D+ 上拉电阻。



USB设备通过描述符来表达自己的特征。

- 设备描述符包括：USB协议版本号，设备类型，端点0的最大包大小，厂商ID，设备ID，设备版本号，厂商字符串索引，产品字符串索引，设备序列号索引可能的配置数。
- 配置描述符包括：配置包含的接口数，配置的编号，供电方式，是否支持远程唤醒，电流需求量等。
- 接口描述符包括：接口的编号，接口的端点数，接口使用的 类 子类 协议 等。
- 端点描述符包括：端点号及方向，端点的传输类型，最大包长度，查询时间间隔等。
- 字符串描述符包括：便于人阅读的东西，非必须。



USB枚举：

控制传输

1. USB设备插入后，主机会对其进行复位，复位后其地址为 0 。主机可以对地址 0 进行发送请求，从机根据该请求的参数回复对应的设备描述符，主机确认无误后回复一个长度为零的确认数据包，接下来开始设置地址。

   > 设备描述符最少要 8 个字节，在第 8 个字节包含。主机最多一次读取 18 个字节，不会第二次读取。

2. 24页

3. 

4. 



### 数据结构

USB使用差分信号，包含：

- J状态（对应逻辑0）：D+ 高，D- 低
- K状态（对应逻辑1）：D+低，D- 高
- SE0 状态：D+ 低，D- 低
- Reset信号：同时拉低D+&D-超过10ms，还原USB为未配置状态。



USB采用NRZI编码方式，当数据为 0 时电平反转，为 1 时不反转。

遵循位填充规则，六位一填充。

USB发送流程：USB终端将数据进行位填充之后，使用SIE将数据串行化和NRZI编码后发送到USB的差分线上。

USB接收流程：采样数据线，将数据并行化后去掉位填充，恢复原来的数据。



USB数据的基本单位是 包 。

- 包
  - 同步域：数据传输即将开始。
    - 低速/全速 设备为 7 个 0  和一个 1。
    - 高速设备是 31 个 0  和一个 1。
  - 包标识符：用于标记包的类型。共八位（PID0~PID7），前四位为数据位（PID0~PID3），后四位（PID4~PID7）取反作为校验。
    - 令牌包：PID1~PID0 为 01。
      - 0b 00 01：将要输出数据。
      - 0b 01 01：帧起始数据包。
      - 0b 10 01：将要输入数据。
      - 0b 11 01：开始一个控制传输。
    - 数据包：PID1~PID0 为 11。
      - 0b 00 11：不同类型的数据包。
      - 0b 01 11：不同类型的数据包。
      - 0b 10 11：不同类型的数据包。
      - 0b 11 11：不同类型的数据包。
    - 握手包：PID1~PID0 为 10。
      - 0b 00 10：确定。
      - 0b 01 10：未准备好。
      - 0b 10 10：不确定。
      - 0b 11 10：挂起。
    - 特殊包：PID1~PID0 为 00。
      - 0b 00 00：保留，未使用。
      - 0b 01 00：PING测试（令牌包）。
      - 0b 10 00：分裂事务（令牌包）。
      - 0b 11 00：作为令牌包的时候是前导。
      - 0b 11 00：作为握手包的时候是错误。
  - 包结束符：
    - 低速/全速 设备为 两个数据宽度的 SE0 。
    - 高速设备 为 故意的位填充错误。



令牌包。USB是主从结构，仅能主机发送数据，从机接收数据。

- 输出：将要输出一个数据包。
- 输入：让从机返回一个数据包。
- 建立：
- 帧起始：



- 









USB拔插事件会触发主机的中断（或回调），执行从机的加载、释放过程。

USB 系统中的管道共有两种，分别为控制管道和数据管道。

USB 规范中定义了四种不同的数据传输类型。使用哪个管 道由数据传输类型决定。

- 控制传输：用于将指令发送到设备上、进行查询并且配置设备。该传输使用了控制管道。

- 中断传输：用于发送少量的突发性数据，并且保证传输延迟最小。该传输使用了数据管道。

- 批量传输：利用了全部可用的 USB 带宽来传输大量数据，但传输速度或延迟得不到保证。该传输使用了数据管 道。

- 同步传输：数据传输采用了得到保证的传输速率。随着传输延迟和总线带宽的保证，传输时间也得到保证。同步传输没有错误纠正功能，因此在重新发送有误的数据包过程中，不能停止传输。该传输使用了数据管道。

## STM32

在STM32F103的USB模块中有一个 RAM 区，包含 512 字节。

- FS 全速
- LS 低速
- MAC 介质访问控制器
- OTG On-the-go
- PFC 数据包FIFO 控制器
- PHY 物理层
- USB 通用串行总线
- UTMI USB 2.0收发器宏单元接口 (UTMI)

