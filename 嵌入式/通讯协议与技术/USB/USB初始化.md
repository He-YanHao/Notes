# USB初始化

## 判断插入

主机 D+ D- 接15KΩ下拉电阻，从机 D+ 或 D- 连接上拉1.5KΩ电阻到3.3V(低速USB接到D-上，全速和高速USB接到D+上)。

双方通过电平变化就可以发现USB的拔插事件。

主机悬空时 D+ D- 被接的15KΩ下拉电阻拉到低电平。

USB设备插入后从机上拉电阻将主机对应管脚拉高到3V左右，主机从而判断从机插入。

然后根据 D+ 或 D- 被拉高判断主机接入的是USB低速 全速 高速设备：

-   若是 D- 被拉高则是低速设备；

-   若是 D+ 被拉高则是全速设备；

-   高速设备先识别为全速设备再通过一系列的数据交换被识别为高速设备。

    若为高速模式，则是电流传输，断开 D+ 上拉电阻。



## 获取设备描述符 (首次)

会首先获得一个8个字节的不完整的设备描述符(完整版18字节)，完成基本配置。



## 设置地址

主机分配唯一设备地址。





## 获取完整设备描述符

使用新分配的地址。



## 获取配置描述符





## 选择配置

主机选择





协议规定每个USB设备使用一个7bit的地址，其中地址 0 供给未初始化的设备，剩下127个地址，所以一个USB主控制器最多可以连接127个USB设备。







USB设备通过描述符来表达自己的特征。

- 设备描述符包括：USB协议版本号，设备类型，端点0的最大包大小，厂商ID，设备ID，设备版本号，厂商字符串索引，产品字符串索引，设备序列号索引可能的配置数。
- 配置描述符包括：配置包含的接口数，配置的编号，供电方式，是否支持远程唤醒，电流需求量等。
- 接口描述符包括：接口的编号，接口的端点数，接口使用的 类 子类 协议 等。
- 端点描述符包括：端点号及方向，端点的传输类型，最大包长度，查询时间间隔等。
- 字符串描述符包括：便于人阅读的东西，非必须。



USB枚举：

控制传输

1. USB设备插入后，主机会对其进行复位，复位后其地址为 0 。主机可以对地址 0 进行发送请求，从机根据该请求的参数回复对应的设备描述符，主机确认无误后回复一个长度为零的确认数据包，接下来开始设置地址。

    > 设备描述符最少要 8 个字节，在第 8 个字节包含。主机最多一次读取 18 个字节，不会第二次读取。

2. 24页

3. 

4. 

