# 任务通知

## 基础介绍

FreeRTOS 的任务通知（Task Notifications）是一种高效、轻量级的任务间通信和同步机制。

直达任务通知是直接发送到任务的事件，而不是通过中间对象 （如队列、事件组或信号量）间接发送至任务的事件，通常具有更高的性能和更少的内存开销。

每个 RTOS 任务都有一个任务通知数组。

启用任务通知后，每个任务都有通知状态和至少一个 32 位的通知值。

常量 `configTASK_NOTIFICATION_ARRAY_ENTRIES` 设置任务通知数组中的索引数量。

>   在 FreeRTOS V10.4.0 版本前，任务只有单条任务通知， 而无通知数组。



## 核心概念

### 通知状态

每个任务还有一个“通知状态”，可以是：
*   **`eNotWaitingNotification`：** 任务没有在等待通知（默认状态）。
*   **`eWaitingNotification`：** 任务正在阻塞等待接收通知（等待通知状态）。
*   **`eNotified`：** 任务在等待期间已被通知，但是还没有处理通知（已收到通知）。

任务默认处于 没有在等待通知 状态，当任务调用 接受任务通知但未接到任务通知时 处于 等待通知状态，一旦接到任务通知，则短暂过渡到已收到通知状态，很快会重新转化为 默认的没有在等待通知状态。

若等待接收通知超时，直接转化为 默认的没有在等待通知状态。

**注意：**数组中的每条通知均独立运行，任务一次只能阻塞数组中的一个通知， 并且不会被发送到任何其他数组索引的通知解除阻塞。



### 发送任务通知

任意一个任务都可以直接更新另一个任务的通知值。

向任务发送“直达任务通知”可以使用下列任一方法更新目标通知的值：

*   **覆盖原值：** 
    *   无论接收任务是否读取被覆盖的值。
    *   但前提是接收任务已读取被覆盖的值。
*   **增加/减少值：** 在接收任务当前通知值上增加或减少一个数值（常用于计数信号量）。
*   **设置位：** 在接收任务的通知值中设置指定的位（常用于事件标志组）。
*   **无更新：** 仅改变接收任务的通知状态（常用于二值信号量）。



### 读取任务通知

任务可以随时读取自己的通知值（无论是否在等待状态），并且可以选择在读取后是否自动将其清零。



## 性能优势和使用限制

任务通知具有高度灵活性， 使得它们可以在必须要创建单独队列、二进制信号量、计数信号量或事件组的情况下进行使用。

与通过诸如二进制信号量等中间对象来解除任务阻塞状态相比，通过直接通知解除 RTOS 任务阻塞状态的速度快 **45%**， **使用的 RAM** 也更少。不过 这些性能优势也有一些意料之内的使用限制：

1.  RTOS 任务通知仅可在只有一个任务可以接收事件时使用。不过，这个条件在大多数真实世界情况下是满足的。比如，中断解除了一个任务的阻塞状态，该任务将处理由中断接收的数据。
2.  仅可在使用 RTOS 任务通知代替队列的情况下：当某个接收任务可在阻塞状态下等待通知 （因而不花费任何 CPU 时间）时，发送任务不能 在阻塞状态下等待发送完成（在发送不能立刻完成的情况下） 。



## 基本使用模式

| **使用方式** | **解释方法**           | **API 操作**                       | 典型场景       |
| :----------- | :--------------------- | :--------------------------------- | :------------- |
| **简单标志** | 非零表示事件发生       | `eNoAction` + `ulTaskNotifyTake`   | 二值信号量     |
| **计数器**   | 数值表示资源数量       | `eIncrement` + `ulTaskNotifyTake`  | 计数信号量     |
| **位掩码**   | 每个比特位表示独立事件 | `eSetBits` + `xTaskNotifyWait`     | 事件标志组     |
| **数据载体** | 直接传输 32 位数据     | `eSetValue...` + `xTaskNotifyWait` | 轻量级消息传递 |



## 配置启用

任务通知功能在 FreeRTOS 中通常是默认启用的。但需要确保在 `FreeRTOSConfig.h` 中以下配置没有被禁用：

```c
#define configUSE_TASK_NOTIFICATIONS 1
//现在可以设置大于1的值来设定通知值数组，对于复杂应用，可以设置为2-4个索引；
```

默认情况下，RTOS 任务通知功能处于启用状态，并且可以 通过将 `configUSE_TASK_NOTIFICATIONS` 在中设置为 0 从构建中排除（每个任务每个数组索引节省 8 个字节）。

**重要提示：**FreeRTOS流和消息缓冲区在数值索引为 0 时使用任务通知。 如需在调用流或消息缓冲区 API 函数时保持任务通知的状态， 请使用数组索引大于 0 的任务通知。

