# 获取任务运行时间和CPU占用率等统计信息 vTaskGetRunTimeStats()

使用`vTaskGetRunTimeStats()`统计运行时间。

函数原型为：

```c
void vTaskGetRunTimeStats(char *pcWriteBuffer);
```

将结果写入`pcWriteBuffer`里，一般`pcWriteBuffer` >= 512字节。

需要先启用宏：

```c
// 对于 vTaskGetRunTimeStats()
#define configGENERATE_RUN_TIME_STATS        1     // 启用运行时间统计功能
#define configUSE_TRACE_FACILITY             1     // 启用可视化追踪调试功能
#define configUSE_STATS_FORMATTING_FUNCTIONS 1     // 启用格式化函数功能
```



输出结果案例：

```
Key            	952890		1%
LED2_Toggle_Tas	16242		<1%
LED1_Toggle_Tas	1609		<1%
IDLE           	71964959	98%
Tmr Svc        	1174		<1%
```

解析

```
任务名           任务运行时间  运行时间占比
Key            	952890		1%
LED2_Toggle_Tas	16242		<1%
LED1_Toggle_Tas	1609		<1%
IDLE           	71964959	98%
Tmr Svc        	1174		<1%
```



## 高精度定时器

`vTaskGetRunTimeStats()` 函数的实现需要一个高精度定时器。

```c
// 使用 DWT 周期计数器 (Cortex-M3/M4)
#include "core_cm3.h" // 确保包含 CMSIS 头文件
//初始化用于运行时统计的定时器
void ConfigureTimerForRuntimeStats(void) {
    /* 启用 DWT 计数器 */
    CoreDebug->DEMCR |= CoreDebug_DEMCR_TRCENA_Msk;
    DWT->CYCCNT = 0;
    DWT->CTRL |= DWT_CTRL_CYCCNTENA_Msk;
}
//获取当前定时器的计数值
uint32_t GetRuntimeCounterValue(void) {
    /* 返回 CPU 周期计数 */
    return DWT->CYCCNT;
}
```



