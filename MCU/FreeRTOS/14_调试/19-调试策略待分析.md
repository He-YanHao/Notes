

### 🛠 二、高级调试工具

1.  **Tracealyzer (Percepio):**
    *   **行业标准可视化跟踪工具。** 通过修改 FreeRTOS 内核插入跟踪点，捕获任务调度、中断、资源操作（队列、信号量、互斥量、事件组）、用户事件等。
    *   **提供强大的图形化视图:**
        *   **主跟踪视图:** 时间线上的任务状态变化（运行/就绪/阻塞/挂起）和事件。
        *   **CPU 负载视图:** 各任务和中断占用 CPU 的比例。
        *   **响应时间分析:** 测量中断到任务响应的延迟。
        *   **资源视图:** 展示队列、信号量的使用情况和任务间的交互。
        *   **死锁/优先级反转检测:** 自动识别潜在问题。
    *   **优势:** 直观、强大，能发现 printf 难以捕捉的时序和并发问题。提供免费评估版（功能受限）和付费版。
    *   **集成:** 需要将 Trace Recorder 库集成到你的工程中（通常只需包含几个文件并配置）。

2.  **调试器 (GDB/LLDB with IDE - Eclipse, VS Code, IAR, Keil):**
    *   **断点 (Breakpoints):** 在关键代码行、函数入口、断言处设置断点。注意断点可能影响实时性。
    *   **单步执行 (Stepping):** 逐行执行代码。
    *   **查看变量和内存 (Watch/Expressions/Memory View):** 监控全局变量、局部变量、任务栈内容、队列/信号量结构体。
    *   **调用栈 (Call Stack):** 发生崩溃或断点时，查看函数调用链，定位问题源头。
    *   **RTOS 感知插件 (RTOS Awareness Plugins):** **强烈推荐！** 现代 IDE 调试器（如 STM32CubeIDE, IAR EWARM, Keil uVision, SEGGER Ozone）通常有 FreeRTOS 感知插件。启用后，调试器可以：
        *   在调试窗口中直接显示任务列表（名字、状态、优先级、栈指针、高水位线）。
        *   显示队列、信号量、互斥量、定时器的状态和内容。
        *   查看任务的控制块 (TCB)。
        *   大大提升调试效率，无需手动查询状态。

3.  **系统查看器 (SystemView - SEGGER):**
    *   类似于 Tracealyzer 的开源替代方案（功能稍逊）。提供任务调度和中断的时间线视图。集成 J-Link 效果最佳。

4.  **内存分析工具:**
    *   使用调试器或 IDE 自带的内存分析功能。
    *   检查堆的使用情况（如果使用动态内存）。FreeRTOS 的 `heap_x.c` 源文件提供了 `xPortGetFreeHeapSize()`, `xPortGetMinimumEverFreeHeapSize()` 等函数查询堆信息。
    *   检查栈溢出（结合调试器查看栈边界和填充模式）。

### 🧠 三、调试策略与技巧

1.  **增量开发与测试:** 不要一次性写太多代码。添加新功能或任务后，充分测试其独立功能以及与已有部分的交互。
2.  **简化复现:** 如果问题难以复现，尝试简化场景（移除不相关任务/功能），或增加日志密度。
3.  **关注并发与共享资源:**
    *   **互斥锁 (Mutexes):** 严格保护共享资源（全局变量、外设）。注意锁的粒度，避免死锁。
    *   **避免在 ISR 中做复杂操作:** 尽快退出 ISR，将处理交给任务。使用 `FromISR` API。
    *   **队列:** 任务间通信的首选方式，提供安全的缓冲机制。
4.  **优先级管理:**
    *   合理设置任务优先级。避免优先级反转（使用优先级继承互斥量 `xSemaphoreCreateMutex()`）。
    *   确保高优先级任务不会长期阻塞低优先级任务（合理使用时间片或协作式调度）。
5.  **利用看门狗 (Watchdog Timer):** 配置硬件看门狗。在关键任务循环或监控任务中定期喂狗。如果系统死锁或任务卡死，看门狗复位可以帮助你定位问题范围（哪个任务没喂狗？）。
6.  **日志时间戳:** 使用 `xTaskGetTickCount()` 或更高精度计时器为日志添加时间戳，分析事件顺序和延迟。
7.  **静态分析工具:** 使用 PC-Lint, Cppcheck 等工具检查潜在代码问题（空指针、数组越界、资源泄露等）。

