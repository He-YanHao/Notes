# 计数信号量 (Counting Semaphore)

## 官方介绍

正如二进制信号量可以被认为是长度为 1 的队列那样， 计数信号量也可以被认为是长度大于 1 的队列。同样，信号量的使用者对存储在队列中的数据并不感兴趣， 他们只关心队列是否为空。

计数信号量通常用于两种情况：

1.  盘点事件。

    在此使用场景中，事件处理程序将在每次事件发生时“提供”信号量（递增信号量计数值）， 而处理程序任务将在每次处理事件时“获取”信号量 （递减信号量计数值）。因此，计数值是 已发生的事件数与已处理的事件数之间的差值。在这种情况下， 创建信号量时希望计数值为零。

2.  资源管理。

    在此使用情景中，计数值表示可用资源的数量。为了获得 对资源的控制，任务必须首先获得信号量——递减信号量计数值。当计数值达到零时， 表示没有空闲资源可用。当任务结束使用资源时， 它会“返还”一个信号量——同时递增信号量计数值。在这种情况下， 创建信号量时希望计数值等于最大计数值。







## 特点

像一个计数器，其值可以在创建时设置上限（最大计数值）。



## 行为

创建时指定一个初始计数值和最大计数值。

`xSemaphoreTake()`：尝试减少计数值（“消耗”一个资源）：

*   如果计数值 > 0，则获取成功，计数值减 1。
*   如果计数值 == 0，则任务可以选择阻塞等待或立即返回失败。

`xSemaphoreGive()`：尝试增加计数值（“归还”一个资源）：

*   如果计数值 < 最大计数值，则释放成功，计数值加 1。
*   如果计数值 == 最大计数值，`xSemaphoreGive()` **失败**（表示资源池已满）。



## 主要用途

**资源池管理：** 管理有限数量的相同资源（如 UART 缓冲区槽位、内存块、数据库连接）。任务“取”信号量获取一个资源使用权，“给”信号量释放资源。

**事件计数：** 记录事件发生的次数。多个事件可以在任务处理前累积（计数值 >1）。