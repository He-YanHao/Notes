# 二值信号量 (Binary Semaphore)

## 官方介绍

二进制信号量用于互斥和同步目的。

二进制信号量和互斥锁极为相似，但存在一些细微差别：互斥锁包括优先继承机制， 而二进制信号量则不然。因此，二进制信号量是 实现同步的更好选择（任务之间或任务与中断之间）， 而互斥锁是实现简单互斥的更好选择。description 对如何将互斥锁用作互斥机制的描述同样适用于二进制信号量。本小节 将仅对使用二进制信号量实现同步进行描述。

信号量 API 函数允许指定阻塞时间。阻塞时间表示在尝试“获取”信号量时， 如果信号量不是立即可用， 任务应进入阻塞状态的最大“滴答”数。如果多个任务在同一信号量上阻塞， 则具有最高优先级的任务将成为下次信号量可用时解除阻塞的任务。

可将二进制信号量视为仅能容纳一个项目的队列。因此，队列只能为空或满 （因此称为二进制）。使用队列完成任务和发生中断无关紧要， 因为队列是空还是满才至关重要。可以利用这项机制同步任务和中断（例如） 。

考虑使用任务为外围设备提供服务的情形。轮询外围设备将会耗费 CPU 资源， 阻止执行其他任务。因此， 最好让任务大部分时间处于阻塞状态（允许其他任务执行）， 只有在确实有事情需要执行时才执行自身。可以通过使用二进制信号量来实现， 方法是“获取”信号量时使任务阻塞。然后为外围设备编写中断例程， 当外围设备需要服务时，只是“提供”信号量。任务 始终“接收”信号量（从队列中读取信号以使队列变空），但从不“提供”信号量。中断 始终“提供”信号量（将写入队列使其为满），但从不获取信号量。



任务优先级可确保外围设备及时获得服务，进而有效生成“延迟中断”方案。

一种替代方法 是使用队列代替信号量。完成此操作后， 中断例程可以捕获与外设事件关联的数据并将其发送到任务的队列中。队列数据可用时， 任务将取消阻塞，从队列中检索数据， 然后执行必要的数据处理。此第二种方案要求中断尽可能短， 在一个任务中进行所有后置处理。



## 基础介绍

**特点**：一个只能有两个状态（0 或 1）的开关。

**行为：**

*   创建时通常初始化为 0（不可用）。
*   一个任务调用 `xSemaphoreTake()` 尝试获取信号量：
    *   如果信号量为 1，则获取成功，信号量值变为 0。
    *   如果信号量为 0，则任务可以选择阻塞等待（指定阻塞时间）或立即返回失败。
*   一个任务（或中断服务程序 ISR）调用 `xSemaphoreGive()` 释放信号量：
    *   如果信号量为 0，则释放成功，信号量值变为 1。
    *   如果信号量为 1，`xSemaphoreGive()` **失败**。
    *   在 FreeRTOS 的标准实现中，尝试释放一个已经是 1 的二值信号量通常返回错误。这表明信号量没有被正确使用（比如同一个任务连续释放两次而没有中间获取）。



## 主要用途

*   **任务间同步：** 一个任务（或 ISR）“给”信号量表示事件发生，另一个任务“取”信号量来等待该事件。

*   **事件通知：** 通知单个任务某个事件。
*   **简单的互斥锁（但非首选）：** 虽然可以用作互斥，但它没有处理优先级反转问题的机制，通常推荐使用互斥量。

