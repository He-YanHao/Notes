# 事件组 Event Groups

事件组是 FreeRTOS 提供的一种**轻量级、高效的多任务同步机制**，特别适用于那些需要**等待多个事件发生或通知多个任务**的场景。它克服了信号量只能表示单一事件或计数的限制。



## 核心概念

**事件标志（Event Flags）：**

-   事件组本质上是一个 **位图（Bitmap）**，通常是一个 `EventBits_t` 类型的变量（通常是 16 位或 32 位，取决于 `configUSE_16_BIT_TICKS` 配置）。这个位图中的每一位（bit）代表一个独立的事件标志。

**设置事件（Setting Events）：**

-   任务或中断服务程序（ISR）可以**设置（置位）** 事件组中的一个或多个位。这表示相应的事件已经发生。

**等待事件（Waiting for Events）：**

-   任务可以**等待（阻塞自身）** 事件组中的一个或多个位被设置。任务可以指定它需要等待哪些位（一个或多个），以及等待的逻辑关系（所有位都被设置，或者任意一个位被设置）。

**清除事件（Clearing Events）：**

-   任务在读取到事件发生后，可以选择性地**清除（复位）** 事件组中的一个或多个位。

**关键特性与优势**：

- 多事件表示： 一个事件组可以表示多达 16 或 32 个（取决于 `configUSE_16_BIT_TICKS` 和架构）独立的事件，大大节省了资源（相比创建多个信号量）。

**灵活等待条件：**

*   `xEventGroupWaitBits()` 允许任务指定它需要等待哪些位 (`uxBitsToWaitFor`)。
*   同时指定等待逻辑：
    *   `xWaitForAllBits = pdTRUE`: 任务等待**所有**指定的位都被置位（逻辑与）。
    *   `xWaitForAllBits = pdFALSE`: 任务等待**任意一个**指定的位被置位（逻辑或）。



## 特点

**高效通知：**

-   设置事件 (`xEventGroupSetBits()`) 操作非常高效，通常只是一个位操作。它会自动解除所有因为等待这些位而被阻塞的任务（如果条件满足）。

**中断安全：**

-   提供专门的中断安全版本 API `xEventGroupSetBitsFromISR()` 和 `xEventGroupGetBitsFromISR()`，允许在 ISR 中设置事件或读取当前事件位状态（但不能在 ISR 中等待事件）。

**轻量级：**

-   事件组本身结构简单，操作开销小，非常适合资源受限的嵌入式系统。

**同步多个任务：**

-   一个事件组可以被多个任务同时等待。设置一组事件位可以一次性唤醒所有等待条件满足的任务。



## 典型应用场景

**等待多个事件完成：**

-   一个任务需要等待来自不同源（如多个传感器、多个通信接口）的事件都发生后才继续执行。使用事件组，该任务可以等待所有相关位被置位 (`xWaitForAllBits = pdTRUE`)。

**等待任意一个事件发生：**

-   一个任务可以响应来自多个源中任意一个事件的发生。例如，一个状态机等待超时或收到用户输入。使用事件组等待任意一个位被置位 (`xWaitForAllBits = pdFALSE`)。

**广播事件给多个任务：**

-   一个事件（如系统启动完成、错误发生）需要通知多个不同的任务。设置一个特定的位，所有等待该位的任务都会被解除阻塞。

**组合事件状态：**

-   任务可以读取事件组的值，将其视为一个包含多个布尔状态（事件是否发生）的变量，并根据组合逻辑做出决策（不阻塞）。

**轻量级状态机：**

-   事件组中的位可以用来表示状态机当前的条件或触发状态迁移的事件。



## 使用注意事项

**同步与互斥：**

-   事件组本身**不提供互斥**访问共享资源的功能。如果多个任务在读取事件位后需要访问共享资源，仍然需要使用互斥锁（Mutex）或信号量来保护。

**位操作：**

-   理解位掩码操作 (`|`, `&`, `<<`, `>>`, `~`) 是使用事件组的关键。清晰地定义每个位的含义（使用宏或枚举）非常重要。

**清除策略：**

*   `xClearOnExit` 参数提供了一种自动清除机制。
*   也可以手动调用 `xEventGroupClearBits()` 清除不再需要的事件标志。
*   设计好清除策略，避免事件被错误地遗留或过早清除。

**守护任务：**

-   使用 `FromISR` API 时，需要确保 FreeRTOS 的守护任务（Daemon Task）被启用（`configUSE_TIMERS` 通常需要为 1，因为守护任务由定时器服务使用）。

**资源消耗：**

-   虽然事件组本身轻量，但等待事件组的任务会消耗堆栈空间。确保任务堆栈大小设置合理。



