# PWM输入

## 什么是PWM输入模式？

PWM输入模式是一种特殊的输入捕获模式，它利用定时器的两个捕获通道（通常是通道1和通道2）协同工作，来**单次自动测量**一个外部输入的PWM信号的**频率（周期）** 和**占空比**。

*   **普通输入捕获模式**：通常需要多次捕获和软件计算才能得到一个周期和占空比的值，且在信号变化快时容易出错或丢失数据。
*   **PWM输入模式**：硬件自动完成测量，只需一次捕获就能得到两个精确的数值，极大地减轻了CPU负担，提高了测量的可靠性和效率。



## 为什么需要PWM输入模式？

想象一下你要读取一个遥控器接收机的信号或者一个舵机的反馈信号，它们都是PWM信号。如果你用软件去测量，你需要：
1.  捕获上升沿，记录时间T1。
2.  捕获下降沿，记录时间T2。
3.  捕获下一个上升沿，记录时间T3。
4.  然后计算：
    *   周期 = T3 - T1
    *   高电平时间 = T2 - T1
    *   占空比 = (T2 - T1) / (T3 - T1) * 100%

这个过程不仅繁琐，而且如果在测量过程中被中断打断，很可能得到错误的数据。PWM输入模式就是为了解决这个问题而生的。



## 工作原理（以STM32为例）

PWM输入模式是输入捕获的一个特例，其工作原理非常巧妙：

1.  **信号输入**：待测量的外部PWM信号**只从一个引脚输入**（例如TI1），但这个引脚会**同时映射到两个捕获通道**（IC1和IC2）上。

2.  **通道分工**：
    *   **通道1** 被配置为捕获 **上升沿**。
    *   **通道2** 被配置为捕获 **下降沿**。

3.  **从模式触发**：最关键的一步是配置定时器的**从模式**为**复位模式**，并将**触发源（TS）** 设置为 **通道1** 或 **通道2**（通常是与捕获上升沿相同的通道）。

4.  **工作流程**：
    *   **第一个上升沿**到来时：
        *   通道1捕获到上升沿，记录当前计数器的值（CNT）到捕获寄存器CCR1中。
        *   **同时**，因为这个上升沿也是触发信号，它会使定时器的计数器CNT**复位清零**，从头开始计数。
    *   **下降沿**到来时：
        *   通道2捕获到下降沿，记录当前计数器的值到捕获寄存器CCR2中。**这个值就是高电平的持续时间**。
    *   **下一个上升沿**到来时：
        *   通道1再次捕获上升沿，记录当前计数器的值到CCR1中。**这个值就是整个PWM的周期**（因为上一个上升沿时计数器被清零了）。
        *   计数器再次被复位清零，开始新一轮的测量。

5.  **中断产生**：通常，我们使能通道1的捕获中断（或者溢出中断）。当第二个上升沿到来，CCR1被更新后，会产生一个捕获中断。在中断服务程序中，我们只需直接读取两个寄存器的值：
    *   **周期 = CCR1**
    *   **高电平时间 = CCR2**
    *   **占空比 = (CCR2 / CCR1) * 100%**



## 配置步骤（概要）

以STM32标准库为例，配置PWM输入模式的步骤通常包括：

1.  **初始化GPIO**：将对应引脚配置为浮空输入或上拉输入。
2.  **初始化定时器**：设置基础预分频器，决定计数频率和测量范围。
3.  **配置输入捕获通道**：
    *   将**通道1**映射到TI1（输入引脚），设置为**上升沿捕获**。
    *   将**通道2**映射到TI1（**同一个输入引脚**），设置为**下降沿捕获**。
4.  **配置从模式**：
    *   设置**触发源（TS）** 为 `TI1FP1`（即通道1的滤波后信号）。
    *   设置**从模式**为 **复位模式**。
5.  **使能中断**：使能捕获/比较中断（CC1IE）。
6.  **启动定时器**：使能定时器计数器。
7.  **编写中断服务程序**：在中断中读取CCR1和CCR2，并计算频率和占空比。



## 应用场景

PWM输入模式非常适合需要精确、实时测量PWM信号的场合，例如：

*   **航模/无人机**：读取遥控器接收机发出的PWM信号。
*   **机器人**：读取舵机的反馈信号（部分舵机可反馈位置）。
*   **工业控制**：解析某些传感器或控制器发出的PWM信号。
*   **速度测量**：测量霍尔传感器等产生的PWM频率来计算转速。



## 总结

| 特性     | 描述                                                         |
| :------- | :----------------------------------------------------------- |
| **本质** | 一种特殊的、自动化的**双通道输入捕获**模式。                 |
| **目的** | **高效、准确、自动地**测量一个外部PWM信号的**周期（频率）** 和**脉冲宽度（占空比）**。 |
| **关键** | 利用**从模式**的**复位功能**，将计数器清零与PWM信号的上升沿同步。 |
| **优势** | **硬件自动完成**，CPU只需在中断中读取结果，**可靠性高**，**软件开销极小**。 |
| **限制** | 通常**一个定时器同一时间只能测量一路PWM输入信号**。          |

