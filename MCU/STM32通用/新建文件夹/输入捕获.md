好的，我们来详细介绍一下STM32的输入捕获功能。这是一个非常实用且强大的功能，是STM32定时器模块的核心应用之一。

### 一、输入捕获是什么？

**简单来说，输入捕获就是用于“测量”输入信号的“时间参数”。**

当指定的引脚上发生特定的电平跳变（比如上升沿或下降沿）时，定时器的当前计数值会被瞬间锁存到一个专用的捕获/比较寄存器中。通过读取这个被“捕获”的值，我们就可以计算出信号的：

1.  **频率**
2.  **周期**
3.  **占空比**
4.  **脉冲宽度**

想象一下，它就像一个高精度的秒表。当信号发生变化时，你按下“计时”按钮，记录下当前的时间点。通过比较两次“计时”的时间点差，就能知道中间经过了多长时间。

---

### 二、输入捕获的工作原理

STM32的通用/高级定时器通常每个通道都支持输入捕获功能。其核心工作原理涉及两个关键动作：**“捕获”** 和 **“中断”**。

#### 核心组件：

1.  **时基单元**：一个自由运行的计数器（CNT），由内部时钟（CK_CNT）驱动，不断向上计数。
2.  **捕获/比较寄存器（CCRx）**：每个通道都有一个。在输入捕获模式下，它的作用是锁存发生捕获事件时的CNT值。
3.  **捕获/比较通道**：硬件连接，将外部引脚（如TIMx_CHx）的信号引入定时器内部。
4.  **输入滤波器**：用于滤除信号上的高频毛刺，提高测量可靠性。
5.  **边沿检测器**：可配置为在上升沿、下降沿或双边沿触发捕获。
6.  **预分频器**：可以对输入信号进行分频（如每N个边沿触发一次捕获），用于测量频率很高的信号。

#### 工作流程（以测量周期为例）：

1.  **初始化配置**：
    *   配置GPIO引脚为复用功能模式，对应到特定的定时器通道。
    *   初始化定时器时基（预分频器PSC、自动重装载值ARR），这决定了计数器的频率和计数范围。
    *   将定时器通道配置为**输入捕获模式**。
    *   设置捕获的**触发边沿**，例如先设置为**上升沿捕获**。
    *   使能捕获/比较中断和/或DMA请求。

2.  **第一次捕获**：
    *   当引脚上出现第一个**上升沿**时，当前计数器CNT的值被瞬间复制到CCR1寄存器中。
    *   同时，硬件会设置一个**捕获标志位（CCxIF）**，并可能产生一个中断。

3.  **处理与第二次捕获**：
    *   在中断服务函数中，我们**清除捕获标志位**，并将触发边沿改为**下降沿捕获**（如果测量脉宽）或保持上升沿但记录下CCR1的值（如果测量周期）。
    *   当信号出现**下降沿**时，CNT的值再次被捕获到CCR1，并再次触发中断。

4.  **计算**：
    *   在第二次中断中，我们读取新的CCR1值。
    *   **两次CCR1值的差值**，就是信号高电平（或一个周期）所对应的计数器计数个数。
    *   **时间 = 计数值 × 计数器时钟周期**。
        *   `计数器时钟周期 = 1 / (定时器时钟频率 / (PSC + 1))`
        *   **信号周期（或脉宽） = 差值 × 计数器时钟周期**

---

### 三、STM32的增强功能：PWM输入模式

这是输入捕获的一个特殊应用，专门用于**仅用一个通道精确测量PWM信号的周期和占空比**。

*   **原理**：该模式将同一个输入信号同时映射到两个捕获通道（如通道1和通道2）上。
*   **通道1**（通常是TI1FP1）被设置为**上升沿捕获**，用于捕获整个周期的开始点。
*   **通道2**（通常是TI1FP2）被设置为**下降沿捕获**，用于捕获高电平结束的点。
*   这样，**一次PWM周期**就能自动测出周期和占空比，无需在中断中手动切换边沿，效率更高，精度也更高。

---

### 四、编程步骤与要点（以HAL库为例）

1.  **GPIO初始化**：配置引脚为AF模式，上拉/下拉根据实际电路决定。
2.  **定时器时基初始化**：配置`TIM_HandleTypeDef`结构体，设置`Prescaler`、`Period`（ARR）、`ClockDivision`等。
3.  **输入捕获通道初始化**：使用`HAL_TIM_IC_ConfigChannel()`函数。
    *   配置结构体`TIM_IC_InitTypeDef`：
        *   `ICPolarity`：触发边沿（上升沿、下降沿等）。
        *   `ICSelection`：选择输入源（直接TIx，间接TIx，TRC）。
        *   `ICPrescaler`：输入预分频器。
        *   `ICFilter`：输入滤波器值。
4.  **启动捕获**：
    *   `HAL_TIM_IC_Start()`：以轮询模式启动。
    *   `HAL_TIM_IC_Start_IT()`：以中断模式启动（最常用）。
    *   `HAL_TIM_IC_Start_DMA()`：以DMA模式启动（用于高频信号，避免CPU频繁中断）。
5.  **编写中断服务函数**：
    *   在`TIMx_IRQHandler`中调用`HAL_TIM_IRQHandler()`。
    *   重写HAL库的捕获中断回调函数`HAL_TIM_IC_CaptureCallback()`。
    *   在回调函数中处理标志位、切换边沿、读取CCR值并进行计算。

#### 处理计数器溢出的重要技巧

当信号周期很长，计数器CNT可能会从ARR值溢出并归零。如果不处理，直接计算两次捕获的差值会出错。

**解决方法**：
*   **开启更新中断**：使能定时器的更新事件中断（计数器溢出时产生）。
*   **使用一个全局变量（如`Capture_Number`）记录溢出次数**。
*   在**更新中断**中，让`Capture_Number`加1。
*   计算时间时：**总时间 = （溢出次数 × （ARR + 1） + 本次CCR值 - 上次CCR值） × 时钟周期**。

---

### 五、典型应用场景

*   **超声波测距**：测量超声波反射回波的高电平脉冲宽度。
*   **红外遥控解码**：解码NEC等协议的红外信号，其逻辑“0”和“1”由不同宽度的脉冲表示。
*   **PWM信号分析**：测量未知PWM信号的频率和占空比。
*   **旋转编码器**：配合编码器模式，测量转速和方向。
*   **频率计**：制作一个简单的数字频率计。

### 总结

| 特性         | 描述                                                     |
| :----------- | :------------------------------------------------------- |
| **核心功能** | 精确测量输入信号的时间参数（频率、周期、占空比、脉宽）。 |
| **核心机制** | 在信号边沿触发时，锁存定时器计数器的当前值到CCRx寄存器。 |
| **关键配置** | 触发边沿、输入滤波器、预分频器、时基（PSC和ARR）。       |
| **工作模式** | 普通输入捕获模式、PWM输入模式（高级）。                  |
| **编程要点** | 初始化配置、中断处理、计数器溢出处理、时间计算。         |
| **优势**     | 硬件实现，测量精度高，不占用CPU时间（尤其在DMA模式下）。 |

希望这份详细的介绍能帮助你彻底理解STM32的输入捕获功能！在实际项目中，结合具体的数据手册和参考手册进行编程是至关重要的。