好的，我们来详细介绍一下STM32微控制器中的两种看门狗：**独立看门狗** 和 **窗口看门狗**。

### 看门狗的基本概念

在看具体区别之前，首先要理解看门狗到底是什么。

你可以把看门狗想象成一个 **“死循环检测器”** 或 **“系统守护者”**。
*   **工作原理**：程序需要在一个固定的时间间隔内（在MCU“饿死”之前）去“喂狗”（执行一个特定操作，通常是向看门狗的寄存器写入一个特定值）。如果程序因为进入死循环、跑飞等异常情况而没能及时“喂狗”，看门狗就会强制让整个系统复位，从而让程序从起点重新开始运行，摆脱异常状态。
*   **核心目的**：提高系统的可靠性和稳定性，防止软件故障导致系统长时间“卡死”。

STM32提供了两种看门狗，它们的设计目标和应用场景有所不同。下面我们通过一个表格和详细说明来对比。

### 对比总结表

| 特性         | 独立看门狗                                         | 窗口看门狗                                                   |
| :----------- | :------------------------------------------------- | :----------------------------------------------------------- |
| **时钟源**   | **独立的内部低速RC振荡器**                         | **主时钟**                                                   |
| **缩写**     | IWDG                                               | WWDG                                                         |
| **时钟频率** | 约32kHz或40kHz（因型号而异，不受主频影响）         | 由APB1时钟分频得到（与系统主频相关）                         |
| **复位条件** | **超过重载值的时间未喂狗**                         | **1. 超过窗口时间上限未喂狗（太晚）** <br> **2. 在窗口时间下限之前喂狗（太早）** |
| **精度**     | 较低（因LSI RC振荡器精度较低）                     | 较高（因时钟源精度高）                                       |
| **应用场景** | **防止硬件故障、程序跑飞**                         | **监测软件逻辑错误、任务阻塞**                               |
| **配置方式** | 通过寄存器或**硬件选项字节**（可在停机模式下工作） | 只能通过软件寄存器配置                                       |
| **中断能力** | **无**（直接产生复位）                             | **有**（可在复位前产生提前中断，用于紧急处理）               |
| **本质**     | **一个12位的递减计数器**                           | **一个7位的递减计数器**                                      |

---

### 独立看门狗

#### 1. 核心特点
*   **完全独立**：它的时钟来自芯片内部的低速RC振荡器。这意味着即使主时钟（HSE/HSE/HSI）发生故障，IWDG依然能正常工作。这是它最大的优势。
*   **简单粗暴**：它就像一个简单的倒计时器。你设置一个超时时间（重载值），如果在这个时间结束前没有“喂狗”（向`KR`寄存器写入`0xAAAA`），计数器减到0时就会产生系统复位。
*   **可靠性极高**：由于不依赖于主系统，它能应对最严重的软件错误和部分硬件时钟故障。

#### 2. 工作流程
1.  **启用**：向键寄存器写入`0xCCCC`来启动IWDG。
2.  **配置**：向键寄存器写入`0x5555`来解锁预分频器和重载值寄存器，然后设置预分频系数和重载值。**一旦启动，这些配置在下次复位前不能再更改**，防止失控的程序修改看门狗设置。
3.  **喂狗**：在计数器减到0之前，向键寄存器写入`0xAAAA`，重载值会被重新加载到计数器，重新开始倒计时。
4.  **复位**：如果未及时喂狗，计数器到0，系统复位。

#### 3. 超时时间计算
`Timeout = (重载值 * 预分频系数) / LSI频率`

例如：LSI=40kHz，预分频=64，重载值=625。
`Timeout = (625 * 64) / 40000 = 1秒`

#### 4. 典型应用
*   需要高可靠性的工业控制设备。
*   防止任何原因导致的程序死锁。
*   作为最后一道防线，确保系统在任何异常情况下都能恢复。

---

### 窗口看门狗

#### 1. 核心特点
*   **“窗口”概念**：这是它与IWDG最根本的区别。喂狗不能太晚，也不能太早！你必须在一个特定的“时间窗口”内喂狗。
    *   **上窗口**：一个由用户配置的固定值（`W[6:0]`）。
    *   **下窗口**：固定为0x3F。当计数器减到0x3F时，会产生复位。
    *   **喂狗安全区**：只有当计数器的值**小于上窗口值且大于0x3F**时，喂狗才是被允许的。
*   **与主时钟同步**：它的时钟来自APB1总线时钟，因此精度高，但依赖主时钟。
*   **可产生中断**：当计数器减到0x40时，会产生一个“早期警告”中断。你可以在中断服务函数里进行一些紧急数据保存或日志记录，然后再进行喂狗或等待复位。

#### 2. 工作流程与复位条件
WWDG的计数器是一个7位递减计数器，从用户设置的值（T[6:0]）开始递减。

*   **复位条件1（喂狗太晚）**：如果计数器减到了0x3F，系统复位。这和IWDG类似。
*   **复位条件2（喂狗太早）**：如果在计数器值**大于**上窗口值（即还在“窗口”之外）时就提前喂狗，系统会**立即复位**。

![](%E7%AA%97%E5%8F%A3%E7%9C%8B%E9%97%A8%E7%8B%97%E7%95%85%E9%94%80%E5%9B%BE.png)

#### 3. 典型应用
*   **监测关键任务的执行周期**。例如，一个任务必须每10ms执行一次，但不能超过15ms。你可以将窗口上边界设置为15ms，下边界设置为10ms。如果任务执行太快（<10ms）或太慢（>15ms）都会触发复位。
*   监测由外部事件触发的程序流程是否正常。
*   需要在高精度时间约束下保证软件逻辑正确的场景。

---

### 如何选择？

*   **选择独立看门狗：**
    *   当你需要最高级别的可靠性，用来应对最坏情况的硬件或软件故障时。
    *   当你的应用对喂狗时间的要求不那么精确，只需要一个“别死机”的保障时。
    *   例如：一个数据采集器，即使程序异常，复位后重新开始采集也比一直卡死要好。

*   **选择窗口看门狗：**
    *   当你的程序有严格的时间序列要求，需要确保某些任务既不能执行得太快，也不能执行得太慢时。
    *   当你希望在系统复位前有机会执行一些“临终”操作（如保存关键数据）时。
    *   例如：一个电机控制器，它的控制算法循环必须严格在1ms内完成，过早或过晚都会影响控制效果。

**在实际项目中，很多开发者会同时使用两者**：用IWDG作为最终的、可靠的硬件故障保护，用WWDG来监测和保证核心软件任务的健康运行。

希望这个详细的解释能帮助你彻底理解STM32的两种看门狗！