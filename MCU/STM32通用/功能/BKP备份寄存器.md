# BKP备份寄存器

## 什么是BKP备份寄存器？

BKP备份寄存器是STM32微控制器中一组特殊的、具有**备份电源**功能的寄存器。

它的核心特点是：**当主电源（VDD）断开时，只要备份电源（VBAT）存在（例如，通过纽扣电池供电），这些寄存器里的数据就不会丢失。**

你可以把它想象成微控制器内部的一个“小EEPROM”，但访问速度更快，寿命无限（因为是静态RAM）。



## 主要特性与作用

1.  **数据保持**：最主要的功能。在系统断电或待机模式下，用于保存关键数据，如：
    *   系统配置参数（如IP地址、校准系数）
    *   运行时间、事件计数
    *   设备序列号
    *   闹钟设置（当与RTC结合时）

2.  **RTC相关功能**：
    *   **RTC日历**：BKP寄存器常用来存储RTC的初始化状态标志。例如，第一次上电时配置RTC，之后系统复位或唤醒时，通过检查BKP中特定标志位来判断RTC是否已经初始化过，避免重复初始化导致时间重置。
    *   **RTC闹钟**：可以存储闹钟相关的数据。

3.  **侵入检测**：这是一个非常重要的功能。
    *   STM32提供了一个**侵入检测引脚（TAMPER）**，通常与BKP功能绑定。
    *   当该引脚上检测到指定的电平边沿（如上升沿）时，会产生一个侵入检测事件。
    *   **此事件会擦除整个BKP备份寄存器的所有内容**，并将其标志位置位。
    *   **应用场景**：用于检测设备是否被非法打开。例如，将TAMPER引脚连接到一个机箱开关上，一旦机箱被打开，引脚电平变化，触发侵入事件，自动清空所有敏感数据（如密钥、密码），保证数据安全。

4.  **校验功能**：部分型号的STM32（如F1系列）的BKP寄存器还带有一个免费的校验位，可用于简单的数据校验。



## 电源结构

BKP功能的实现依赖于一个独立的电源域，即**备份域**。

*   **主电源（VDD）**：为CPU、主存储器、大部分外设供电。
*   **备份电源（VBAT）**：专门为备份域内的电路供电。备份域通常包括：
    *   BKP备份寄存器
    *   RTC（实时时钟）
    *   低速振荡器（LSE）

**电源切换逻辑**：
*   当VDD正常供电时，整个芯片由VDD供电，VBAT引脚即使有电也不会被使用。
*   当VDD掉电后，供电会自动切换到VBAT引脚，由后备电池（如3V纽扣电池）为备份域供电，从而保持BKP数据和RTC的运行。



## 访问BKP寄存器的重要前提

由于BKP属于备份域，访问它之前必须满足一个关键条件：**使能备份域的写访问**。

在STM32的标准外设库或HAL库中，这通常通过以下步骤实现：

1.  **使能PWR（电源控制）时钟**：因为备份域的控制位在电源控制模块中。
2.  **使能对备份域的写访问**：调用库函数 `HAL_PWR_EnableBkUpAccess()` 或 `PWR_BackupAccessCmd(ENABLE)`。

**为什么需要这一步？**
这是一种安全措施。

默认情况下，系统复位后，软件是不能修改BKP寄存器的，以防止意外写入。只有显式地“解锁”后，才能进行写操作。





## 不同STM32系列的差异

*   **STM32F1系列**：
    *   有42个16位的BKP备份寄存器（BKP_DR1 ~ BKP_DR42）。
    *   侵入检测功能是专用的TAMPER引脚（PC13）。

*   **STM32F4/F7/H7等系列**：
    *   备份寄存器数量更多，通常是20个32位的寄存器，命名为`RTC_BKPxR`（x=0~19）。
    *   侵入检测功能可能更加灵活，有时可以与RTC_OUT引脚复用。

**重要提示**：具体型号的BKP寄存器数量、地址和功能请务必查阅对应芯片的**参考手册**。



## 典型使用流程示例

假设我们要在系统第一次运行时设置一个标志。

```c
RTC_HandleTypeDef hrtc; // 假设RTC已初始化

void BKP_Init(void) {
  // 使能PWR时钟和备份域写访问
  __HAL_RCC_PWR_CLK_ENABLE();
  HAL_PWR_EnableBkUpAccess();

  // 检查BKP寄存器中的标志位
  if (HAL_RTCEx_BKUPRead(&hrtc, RTC_BKP_DR0) != 0xCAFE) {
    // 如果读出的值不是我们设定的标志，说明是第一次运行
    printf("首次运行，进行初始化...\n");

    // ... 这里进行你的初始化操作，比如配置RTC时间 ...

    // 在BKP寄存器中写入标志，表示已经初始化过
    HAL_RTCEx_BKUPWrite(&hrtc, RTC_BKP_DR0, 0xCAFE);
  } else {
    // 如果不是第一次运行，可以跳过初始化
    printf("系统已初始化过，从备份域恢复状态...\n");
  }
}
```



## 总结

| 特性         | 描述                                                       |
| :----------- | :--------------------------------------------------------- |
| **核心功能** | 在VDD掉电后，由VBAT供电保持数据不丢失。                    |
| **主要应用** | 保存关键数据、RTC状态标志、实现安全侵入检测。              |
| **关键步骤** | 访问前必须先**使能PWR时钟**并**使能备份域写访问**。        |
| **硬件要求** | 需要在VBAT引脚连接后备电池（如3V纽扣电池）以实现掉电保持。 |
| **安全特性** | 侵入检测（TAMPER）事件可自动清除所有BKP数据。              |

