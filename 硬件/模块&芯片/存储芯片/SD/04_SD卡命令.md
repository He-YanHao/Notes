# SD卡命令

## 命令基础介绍

SD卡的寄存器只能通过对应的命令访问(CMD0-CMD63)，对SD卡进行控制操作并不是像操作控制GPIO相关寄存器那样一次读写一个寄存器的，它是通过命令来控制。

SDIO定义了64个命令，每个命令都有特殊意义，可以实现某一特定功能，SD卡接收到命令后，根据命令要求对SD卡内部寄存器进行修改，程序控制中只需要发送组合命令就可以实现SD卡的控制以及读写操作。

>   并非每个型号的SD卡都支持所以64个命令，有些命令仅存在于特定型号的SD卡。



## 命令类型

SD命令由主机发出，以广播命令和寻址命令为例，广播命令是针对与SD主机总线连接的所有从设备发送的，寻址命令是指定某个地址设备进行命令传输。

SD命令有4种类型：

| 命令类型         |                                                              |
| ---------------- | ------------------------------------------------------------ |
| 无响应广播命令   | 发送到所有卡，不返回任务响应；                               |
| 带响应广播命令   | 发送到所有卡，同时接收来自所有卡响应，但 只有一个有效返回（物理上通过开漏仲裁）； |
| 寻址命令         | 发送到选定卡，DAT线无数据传输；                              |
| 寻址数据传输命令 | 发送到选定卡，DAT线有数据传输。                              |



## 命令格式

SD卡的命令固定为48位，由6个字节组成。

```
0X XX         XX         XX         XX         XX         XX;
0B 0000 0000  0000 0000  0000 0000  0000 0000  0000 0000  0000 0000;
0B abcc cccc  dddd dddd  dddd dddd  dddd dddd  dddd dddd  eeee eeef;
```

- 字节1：
    - 字节1的最高位固定为0。
    - 第二高位为1时表示命令，方向为主机传输到SD卡，该位为0时表示响应，方向为SD卡传输到主机。
    - 低6位为命令号，共有64个命令(代号：CMD0~CMD63)，。
- 字节2~5为命令参数，有些命令是没有参数的。
- 字节6：
    - 字节6的高七位为CRC校验值，用于验证命令传输内容正确性，如果发生外部干扰导致传输数据个别位状态改变将导致校准失败，也意味着命令传输失败，SD卡不执行命令。
    - 最低位恒定为1。
    
    >   例如CMD16: 
    >
    >   ```
    >   0B (0)(1)(01 0000) (0000 0000 0000 0000 0000 0000 0000 0000) (0000 0001);
    >   ```



## SD卡标准下的响应类型

SD卡有多种命令和响应，发送命令时主机只能通过CMD引脚发送给SD卡，串行逐位发送时先发送最高位(MSB)，然后是次高位这样类推。

在主机发送有响应的命令后，SD卡都会给出相对应的应答，以告知主机该命令的执行情况，或者返回主机需要获取的数据。

与命令一样，SD卡的响应也是通过CMD线连续传输的。

在 SD Memory Card（普通存储卡）规范 中，标准定义的响应类型主要是以下 **5 种**（不含 SDIO 扩展）：

| 响应 | 长度   | 描述                                                         |
| ---- | ------ | ------------------------------------------------------------ |
| R1   | 48bit  | 正常响应，告知卡的状态                                       |
| R1b  | 48bit  | 格式与R1相同，卡可能通过拉低DAT0线表示忙状态，直到操作完成。 |
| R2   | 136bit | 用于响应CMD2（请求CID）或CMD10（请求CSD），返回CID或CSD寄存器的值。 |
| R3   | 48bit  | 用于ACMD41命令（SD卡初始化命令），返回OCR（Operating Conditions Register）寄存器的值。 |
| R6   | 48bit  | 用于响应CMD3（发布相对卡地址RCA），返回新分配的RCA和卡状态。 |
| R7   | 48bit  | 用于响应CMD8命令（发送接口条件），返回电压信息和检查模式。   |

SD的响应大体分为短响应48bit和长响应136bit，每个响应也有规定好的格式。

R1、R1b、R3、R6和R7属于短响应，而R2属于长响应。



### 48bit响应的结构

所有短响应的物理帧结构一致：

| 位    | 位宽 | 名称     | 位段             |
| ----- | ---- | -------- | ---------------- |
| 47    | 1    | 开始位   | Start bit        |
| 46    | 1    | 传输位   | Transmission bit |
| 45~40 | 6    | 命令索引 | Command index    |
| 39~8  | 32   | 状态     | Argument/Status  |
| 7~1   | 7    | CRC 校验 | CRC7             |
| 0     | 1    | 结束位   | End bit          |

不同 R 类型只是 **中间 32bit 含义不同**。



### R1 和 R1b 的真正区别

| 项        | R1           | R1b                  |
| --------- | ------------ | -------------------- |
| 响应帧    | 48bit        | 48bit（完全相同）    |
| Busy 信号 | 无           | DAT0 被卡拉低        |
| 用途      | 普通状态反馈 | 擦除、编程等耗时操作 |

**要点：**

>   R1b 本质不是新格式，而是“R1 + Busy 阶段”。



### R2 136bit

| 位      | 位宽 | 名称     | 数值 |
| ------- | ---- | -------- | ---- |
| 135     | 1    | 开始位   | 0    |
| 134     | 1    | 传输位   | 0    |
| 133~128 | 6    | 命令索引 | X    |
| 127~1   | 127  | 状态     | X    |
| 0       | 1    | 结束位   | 1    |

用途：

| 命令 | 返回 |
| ---- | ---- |
| CMD2 | CID  |
| CMD9 | CSD  |



### R3 无有效 CRC

R3（OCR 响应）：

-   CRC 字段存在
-   **但主机不校验**
-   因为初始化阶段 CRC 可能未启用

这是 SD 初始化流程中的关键点。



### R6 RCA响应

R6 的 32bit 数据区：

| 位    | 含义                         |
| ----- | ---------------------------- |
| 16~31 | RCA（Relative Card Address） |
| 0~15  | 卡状态（与 R1 类似）         |



### R7 CMD8 响应

R7 返回：

| 位    | 含义                  |
| ----- | --------------------- |
| 12~31 | 0                     |
| 8~11  | 电压接受范围          |
| 0~7   | Check Pattern（回显） |

用于区分 **SD v1.x vs v2.0+（SDHC/SDXC）**。



## 常用命令

### 复位与建立通讯

#### 复位 CMD0

卡刚插入后，需要通过发送 `CMD0` 进入空闲状态，然后才能进行后续的命令和初始化。

参数：

-   无参数，用 0 填充。

响应：

-   R1 短响应。

#### 获取CID CMD2

使用 `CMD2` 获取 CID（Card Identification Register），即卡的唯一识别信息。

在系统中，每张卡都有一个唯一的 CID，它用于标识卡的身份。

CMD2 是在卡初始化阶段（通常在发送 CMD0 和 ACMD41 后）发送的，它会返回与卡相关的详细信息。

参数：

-   无参数，用 0 填充。

响应：R2 长响应。

| 位      | 作用     | 说明         |
| ------- | -------- | ------------ |
| 128~136 | 响应状态 | 卡的响应状态 |
| 0~127   | CID      |              |



#### 获取RCA CMD3

使用 `CMD3` 获取16位的相对卡地址RCA，用以代替128位的CID指定SD卡，作为主机与卡之间建立唯一的标识符。

后续很多命令需要使用RCA来选择或指定SD卡。

**参数：**

-   无参数，用 0 填充。

**响应：** R6

| 位    | 作用                  | 说明                          |
| ----- | --------------------- | ----------------------------- |
| 32~47 | 响应状态              | 卡的响应状态                  |
| 16~31 | 保留                  | 必须为 0                      |
| 15~0  | **RCA（相对卡地址）** | 卡返回的 **RCA**（16 位的值） |

#### 选择或取消选择卡 CMD7

通过这个命令来选中当前的卡进行数据传输。  主机通过 `CMD7` 来选择当前工作卡，执行读取/写入操作。

**参数：**

-   无参数，用 0 填充。

**响应：** R1b





#### 发送接口条件 CMD8

是 SD v2.0+ 新增命令，所以 SD v1.0+ 的卡对此无响应。

目的和作用：

1.  **检查电压范围**：确定主机和卡支持的电压匹配（VHS）。
2.  **检查卡版本**：区分 SD v2.0+ 和 SD v1.x（老卡）。
3.  **校验链路是否通畅**：低 8 位 Check Pattern 必须原样返回。

**参数**：

| 位    | 作用                                            | 说明              |
| ----- | ----------------------------------------------- | ----------------- |
| 31~12 | 保留                                            |                   |
| 11~8  | VHS（Voltage supplied）MCU提供的电压范围        | 0x1 → 2.7V ~ 3.6V |
| 7~0   | Check Pattern（任意校验字节，卡必须返回相同值） | 一般用 0XAA       |

**响应**：

| 位    | 作用                            | 说明        |
| ----- | ------------------------------- | ----------- |
| 47~40 | R1 状态位                       |             |
| 39~8  | 保留                            |             |
| 7~0   | Check Pattern（应与发送的相同） | 一般用 0XAA |



### 开始应用命令

#### 开始应用命令 CMD55

CMD55 用于告诉 SD 卡 **下一条命令是应用命令（ACMD）**，必须在发送 ACMD（如 ACMD41、ACMD6）前使用。

-   CMD55 本身不会改变卡状态，但影响下一条命令的解析
-   初始化阶段 RCA=0；卡分配 RCA 后，RCA 参数指定目标卡

参数：

| 位    | 作用                         | 说明                                   |
| ----- | ---------------------------- | -------------------------------------- |
| 31~16 | RCA（Relative Card Address） | 卡相对地址，高 16 位。初始化阶段 RCA=0 |
| 15~0  | 保留                         | 必须为 0                               |

响应：

| 位    | 作用      | 说明                                      |
| ----- | --------- | ----------------------------------------- |
| 47~40 | R1 状态位 | 表示卡状态，包括 Idle、Illegal Command 等 |
| 39~0  | 保留      |                                           |



### 其他标准命令（CMD）

| 命令  | 数据 | 参数   | 响应 | 作用                                                         | 操作背景                                                     |
| ----- | ---- | ------ | ---- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| CMD1  | 0x01 |        |      | 发送主机支持的电压范围                                       |                                                              |
| CMD2  | 0x02 | NONE   | R2   | 获取 SD 卡的唯一识别号CID。CID 是一个 128-bit 的唯一标识符。 |                                                              |
|       |      |        |      |                                                              |                                                              |
| CMD6  | 0x06 |        |      | 切换卡的功能设置。用于切换卡的操作模式（如 1-bit 或 4-bit 数据传输模式等）。 | 通常用于更改卡的工作模式或切换特定功能。                     |
|       |      |        |      |                                                              |                                                              |
| CMD9  | 0x09 | RCA    | R2   | 读取卡的 CSD 寄存器。CSD（Card Specific Data）包含卡的特定信息，如最大块大小、卡类型等。 | 通过读取 CSD 信息，主机可以了解卡的能力和配置。              |
| CMD10 | 0x0A |        |      | 读取卡的 CID 寄存器，获取卡的唯一身份信息。                  | CID 包含厂商 ID、产品型号、序列号等信息，是卡的唯一标识。    |
| CMD12 | 0x0C |        |      | 停止当前的数据传输。                                         | 此命令用于在进行数据传输过程中，如果出现问题，提前中止数据传输。 |
| CMD13 | 0x0D | RCA    | R1   | 请求卡的状态信息                                             | 卡在执行命令时可能会处于忙状态，主机可通过此命令检查卡的状态。 |
| CMD15 |      |        |      | 将卡置于非活动状态。                                         | 用于将卡置于不活跃状态。                                     |
| CMD16 | 0x10 | 块大小 | R1   | 设置块大小。                                                 | 设置块大小（单位字节），通常是 512 字节。                    |
| CMD17 | 0x11 | 地址   | R1   | 读取一个块的数据。                                           | 此命令用于从卡中读取一个数据块（通常为 512 字节）。          |
| CMD18 |      |        |      | 读取多个数据块。                                             | 此命令用于从卡中读取多个数据块（通常为多个 512 字节块）。    |
| CMD24 | 0x18 | 地址   | R1   | 向卡写入一个数据块。                                         | 此命令用于向卡中写入单个数据块。                             |
| CMD25 |      |        |      | 向卡写入多个数据块。                                         | 此命令用于向卡中写入多个数据块。                             |
| CMD27 |      |        |      | 编程 CSD 寄存器。用于更改卡的一些特性（如卡的容量等）。      | 此命令用于修改 CSD 寄存器中的信息，但并不常用。              |
| CMD28 |      |        |      | 设置写保护。                                                 | 用于对卡进行写保护设置，防止数据被修改。                     |
| CMD29 |      |        |      | 清除写保护。                                                 | 用于解除卡的写保护。                                         |
| CMD30 |      |        |      | 查询写保护状态。                                             | 用于查询卡的写保护状态。                                     |
| CMD32 |      |        |      | 设置擦除起始块。                                             | 用于设置擦除操作的起始块。                                   |
| CMD33 |      |        |      | 设置擦除结束块                                               | 用于设置擦除操作的结束块                                     |
| CMD38 |      |        |      | 执行擦除操作                                                 |                                                              |
| CMD42 |      |        |      | 锁定或解锁卡的保护区域                                       | 用于卡的保护区的管理。                                       |
|       |      |        |      |                                                              |                                                              |



### 应用命令

#### 请求卡的操作条件 ACMD41

ACMD41 用于 初始化 SD 卡，在 发送 CMD55 之后发送，主要用于：

1.  启动卡初始化
2.  检查卡就绪状态
3.  确定卡是否支持高容量（SDHC/SDXC）

参数：

| 位    | 作用                         | 说明                                                     |
| ----- | ---------------------------- | -------------------------------------------------------- |
| 31    | HCS（High Capacity Support） | 1 = 支持 SDHC/SDXC；0 = SDSC                             |
| 30~28 | 保留                         |                                                          |
| 27~0  | VDD Window / OCR 操作条件    | 指定电压范围（主机可提供电压），如 0x00FF8000 = 2.7~3.6V |

-   初始化阶段，HCS 位用于 SD v2.0+ 判断是否支持高容量卡
-   VDD Window 指示主机可提供电压，卡会检查自己是否匹配

#### 响应：

| 位   | 作用                                | 说明                             |
| ---- | ----------------------------------- | -------------------------------- |
| 31   | Card Power Up Status (BUSY)         | 1 = 卡准备就绪，0 = 仍在初始化   |
| 30~0 | OCR (Operating Conditions Register) | 表示卡可支持的电压范围和功能标志 |

-   响应类型：R3（48bit，短响应，不含 CRC）
-   关键位：
    -   **Bit 31 = BUSY** → 卡是否完成初始化
    -   **Bit 30~0 = OCR** → 卡支持的电压范围



### 其他应用命令（ACMD）

| 命令   | 数据 | 参数 | 响应 | 作用                                                 | 操作背景 |
| ------ | ---- | ---- | ---- | ---------------------------------------------------- | -------- |
| ACMD6  |      |      |      | 设置 SD 卡的数据总线宽度，支持 1 位或 4 位数据传输。 |          |
| ACMD13 |      |      |      | 查询 SD 卡的状态。                                   |          |
| ACMD22 |      |      |      | 查询卡的写入块数。                                   |          |
| ACMD23 |      |      |      | 设置写入块擦除计数。                                 |          |
|        |      |      |      |                                                      |          |
| ACMD42 |      |      |      | 设置或清除卡检测功能。                               |          |
| ACMD51 |      |      |      | 读取 SCR 寄存器，获取 SD 卡的特性。                  |          |



