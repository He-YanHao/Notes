# SD卡初始化流程

SD 卡初始化的目的只有三点：

1.  **确认卡存在并能通信**
2.  **确认卡类型与能力**
3.  **把卡切换到“可数据传输状态”**

一切初始化步骤，都是围绕这三点展开。

# 正确

1.  SD 卡上电后需要一段稳定时间 可以适当延时
2.  MCU 初始化GPIO
3.  MCU 初始化SDIO外设 （配置单总线低速模式）
4.  发送 CMD0 进入 Idle 状态
5.  发送 CMD8 探测电压范围 / 判断 SD 版本
    -   成功：SD v2.0+ → HCS=1
    -   超时/非法命令：SD v1.x → HCS=0
6.   CMD55开始应用命令
4.  ACMD41查询是否初始化完毕
5.  CMD2：获取卡唯一标识 CID（长响应 136bit）
9.  CMD3：分配/获取 RCA（相对卡地址）高16位
10.  
11.  





在使用 STM32F103ZET6 和 SDIO 初始化 SD 卡后，完成了 **CMD0**, **CMD8**, **CMD55**, **ACMD41**, **CMD3** 之后，接下来你需要进行以下命令：

1.  **CMD7 (Select/ Deselect Card)**
    用于选择卡。选择卡后，它将成为活动卡，任何与 SDIO 的通信都将针对这个卡。

    ```c
    // CMD7: Select Card
    SDIO_CmdInitStructure.SDIO_CmdIndex = SDIO_CMD_SEL_DESEL_CARD;
    SDIO_CmdInitStructure.SDIO_Argument = RCA << 16; // RCA 是通过 CMD3 获取的相对卡地址
    SDIO_CmdInitStructure.SDIO_Response = SDIO_Response_Short;
    SDIO_CmdInitStructure.SDIO_Wait = SDIO_Wait_No;
    SDIO_CmdInitStructure.SDIO_CPSM = SDIO_CPSM_Enable;
    SDIO_SendCommand(&SDIO_CmdInitStructure);
    ```

    `RCA` 是在之前通过 `CMD3` 获得的相对卡地址（16 位），此时卡已经被选中。

2.  **CMD9 (Send CSD)**
    该命令用于获取卡的 CSD (Card-Specific Data) 寄存器内容。这包含了卡的详细信息，如容量、速度等。

    ```c
    // CMD9: Send CSD
    SDIO_CmdInitStructure.SDIO_CmdIndex = SDIO_CMD_SEND_CSD;
    SDIO_CmdInitStructure.SDIO_Argument = RCA << 16; // RCA
    SDIO_CmdInitStructure.SDIO_Response = SDIO_Response_Long;
    SDIO_CmdInitStructure.SDIO_Wait = SDIO_Wait_No;
    SDIO_CmdInitStructure.SDIO_CPSM = SDIO_CPSM_Enable;
    SDIO_SendCommand(&SDIO_CmdInitStructure);
    ```

    获取 CSD 数据后，你可以解析 CSD 寄存器来获取 SD 卡的一些信息，如大小、块长度等。

3.  **CMD10 (Send CID)**
    该命令用于获取卡的 CID (Card Identification) 寄存器，包含卡的唯一标识信息。

    ```c
    // CMD10: Send CID
    SDIO_CmdInitStructure.SDIO_CmdIndex = SDIO_CMD_SEND_CID;
    SDIO_CmdInitStructure.SDIO_Argument = RCA << 16; // RCA
    SDIO_CmdInitStructure.SDIO_Response = SDIO_Response_Long;
    SDIO_CmdInitStructure.SDIO_Wait = SDIO_Wait_No;
    SDIO_CmdInitStructure.SDIO_CPSM = SDIO_CPSM_Enable;
    SDIO_SendCommand(&SDIO_CmdInitStructure);
    ```

    这些命令执行完之后，SD 卡基本完成初始化，接下来可以开始进行数据传输、块读写等操作。

**注意：** 这些步骤的命令顺序、等待时间、以及响应类型都非常重要，要确保正确的同步和状态检查。

# 正确





**CMD9**：读取 CSD → 得到容量信息

**CMD7**：选择卡 → 卡进入 Transfer 状态

**ACMD6**：切换总线宽度（1bit → 4bit，可选）

后续可以开始 **读/写数据块**



4.  电压与协议版本协商 **这一步决定了“地址怎么理解”，非常关键**

5.  工作条件确认（等待卡就绪）主控必须**轮询确认**

6.  卡识别与参数读取

    此阶段会读取：

    -   卡唯一 ID（序列号）
    -   制造商信息
    -   容量相关参数
    -   最大传输速度
    -   块大小能力

7.  进入数据传输模式 主控为 SD 卡分配一个通信地址 可以开始：

    -   块读
    -   块写
    -   多块操作
    -   提高时钟频率
    -   切换总线宽度（1bit → 4bit）
    -   配置 DMA / 中断 / 轮询模式
    -   挂载文件系统



## 初始化流程

```
CMD0 → CMD8 → CMD55 → ACMD41循环 → CMD2 → CMD3 → CMD7 → ACMD6 → 高速模式 → CMD16
CMD0 → CMD8 → CMD55 → ACMD41循环 → CMD2 → CMD3 → CMD7 → CMD9
// 精简后的正确流程：
CMD0  → 卡复位（进入空闲状态）
CMD8  → 验证电压范围，检测卡版本
循环：
  CMD55 → 应用命令前缀
  ACMD41 → 发送操作条件，等待卡就绪
结束循环后：
CMD2  → 获取CID
CMD3  → 获取相对地址(RCA)
// ... 后续其他命令
```

-   CMD0：初始化
-   CMD8：电压验证
-   ACMD41循环：
-   CMD2：
-   CMD3：
-   CMD7：
-   ACMD6：
-   高速模式：
-   CMD16：



1.  初始化GPIO口，配置好引脚复用。
2.  配置低速时钟，确保初始时钟频率在400kHz左右（SD卡规范要求）。
3.  设置SDIO电源状态为开启
4.  发送CMD0（GO_IDLE_STATE）：使SD卡进入空闲状态，命令参数为0，无响应。
5.  电压验证（可选）：发送CMD8（SEND_IF_COND）检查SD卡版本和电压兼容性，V2.0以上SD卡会响应
6.  **初始化过程** - 循环发送ACMD41（SD_APP_OP_COND）进行初始化：
    - 先发送CMD55（APP_CMD）表明下一个是应用特定命令
    - 再发送ACMD41带上HCS（高容量支持）位
    - 重复直到OCR寄存器中的忙位变为0，表示初始化完成
7.  **获取CID** - 发送CMD2（ALL_SEND_CID）获取卡的唯一标识符
8.  **获取相对地址** - 发送CMD3（SEND_RELATIVE_ADDR）获取SD卡分配的相对地址（RCA）
9.  **选择卡片** - 发送CMD7（SELECT_CARD）使用获取到的RCA选择该SD卡
10.  **设置总线宽度** - 通过ACMD6（SET_BUS_WIDTH）将数据总线从默认的1位切换到4位模式：
     - 先发送CMD55（APP_CMD）
     - 再发送ACMD6设置4位总线宽度
11.  **切换到高速模式** - 调用`SDIO_SwitchToHighSpeed()`函数：
     - 禁用SDIO时钟
     - 重新配置时钟分频器以获得更高频率
     - 重新使能时钟
     - 可能发送CMD6切换到高速传输模式（取决于卡类型）
12.  **设置块长度** - 发送CMD16（SET_BLOCKLEN）设置读写块大小为512字节
13.  **完成初始化** - 此时SD卡已准备好进行数据读写操作

