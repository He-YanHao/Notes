# lsof

## 基础介绍

**`lsof`**（**L**i**s**t **O**pen **F**iles）的字面意思是“列出打开的文件”。在 Linux 哲学中，**“一切皆文件”**。这不仅仅包括普通的磁盘文件，还包括：

*   **目录**
*   **硬件设备**（如磁盘、USB）
*   **网络连接**（套接字，Sockets）
*   **库文件**（`.so`, `.dll`）
*   **匿名管道**（Pipes）和**命名管道**（FIFOs）
*   **被进程使用的其他资源**

因此，`lsof` 命令的真正作用是：**列出当前系统中被进程打开的所有“文件”（即资源）及其对应的进程信息。**

它是一个**系统级调试和诊断的瑞士军刀**，是系统管理员和开发人员解决各类疑难杂症的终极工具之一。



## `lsof` 在进程管理中的核心作用

`lsof` 的核心价值在于它建立了 **“进程”** 与 **“资源”** 之间的双向联系。你可以通过进程找到它打开的所有资源，也可以通过资源找到正在使用它的进程。

### 通过进程找资源：查看特定进程打开了什么

这是最直接的用法。你可以查看任何一个进程正在使用哪些文件、网络连接、库等。

**基本语法：** `lsof -p <PID>`

**示例：** 查看 PID 为 1234 的进程打开的所有资源。
```bash
lsof -p 1234
```
**输出示例解读：**
```
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF    NODE NAME
nginx   1234 root  cwd    DIR  253,0     4096       2 /
nginx   1234 root  rtd    DIR  253,0     4096       2 /
nginx   1234 root  txt    REG  253,0  1160088  123456 /usr/sbin/nginx
nginx   1234 root  mem    REG  253,0    96680  789012 /lib/x86_64-linux-gnu/libnss_files-2.27.so
nginx   1234 root    0u   IPv4  12345      0t0     TCP *:http (LISTEN)
nginx   1234 root    1w   REG  253,0     1024  654321 /var/log/nginx/access.log
nginx   1234 root    2w   REG  253,0     1024  654322 /var/log/nginx/error.log
```
*   **FD (File Descriptor)**：文件描述符，是关键字段。
    *   `cwd`：当前工作目录。
    *   `rtd`：根目录。
    *   `txt`：程序代码（二进制文件本身）。
    *   `mem`：内存映射文件（通常是库）。
    *   `0u`，`1w`，`2w`：标准输入(0)、输出(1)、错误(2)。`u`表示读写，`w`表示写。
    *   数字：其他打开文件的描述符。
*   **TYPE**：文件类型（REG=普通文件，DIR=目录，IPv4=IPv4网络套接字，CHR=字符设备等）。
*   **NAME**：文件或资源的名称。

**作用**：判断进程是否加载了正确的配置文件、是否在写正确的日志文件、监听了哪些端口等。

### 通过资源找进程：查明谁在占用某个资源

这是 `lsof` 最常用的故障排查场景。当你无法操作某个资源（如卸载磁盘、删除文件、绑定端口）时，通常是因为有进程正在占用它。

**常见场景：**

*   **无法卸载磁盘设备**（`umount: /mnt: target is busy.`）：
    ```bash
    # 查看谁在占用挂载点 /mnt
    lsof /mnt
    ```

*   **无法删除文件**（`rm: cannot remove 'file': Operation not permitted`）：
    ```bash
    # 查看谁正在使用这个文件
    lsof /path/to/file
    # 或者，查看被删除但进程仍持有的文件（空间未释放）
    lsof | grep deleted
    ```

*   **排查网络问题：端口被谁占用？**（`Address already in use`）：
    ```bash
    # 查看所有网络连接
    lsof -i
    
    # 查看谁在监听 80 端口
    lsof -i:80
    
    # 查看所有 TCP 连接
    lsof -i TCP
    
    # 查看某台主机的连接（例如查看与百度的所有连接）
    lsof -i @www.baidu.com
    ```

*   **查看某个用户打开的文件**：
    ```bash
    lsof -u username
    ```



## 常用选项组合与高级用法

`lsof` 的选项非常多，以下是一些极其有用的组合：

| 命令                   | 作用                                                         |
| :--------------------- | :----------------------------------------------------------- |
| `lsof -p <PID>`        | 查看指定进程打开的文件                                       |
| `lsof -c <进程名>`     | 查看以`<进程名>`开头的进程打开的文件（如 `lsof -c nginx`）   |
| `lsof -u <用户名>`     | 查看指定用户打开的文件                                       |
| `lsof -i`              | 查看所有网络连接                                             |
| `lsof -i :<端口号>`    | 查看占用指定端口的进程                                       |
| `lsof -i TCP`          | 查看所有 TCP 连接                                            |
| `lsof -i UDP`          | 查看所有 UDP 连接                                            |
| `lsof <文件名或目录>`  | 查看谁正在使用指定的文件或目录                               |
| `lsof +D /path/to/dir` | 递归查看目录下所有被打开的文件（**慢**）                     |
| `lsof +d /path/to/dir` | 查看目录本身（非递归）下被打开的文件（**快**）               |
| `lsof -a -p <PID> -i`  | **组合筛选**（`-a` 表示 AND），查看指定进程的网络连接        |
| `lsof -n`              | 不解析主机名（no hostname resolution），加快速度             |
| `lsof -P`              | 不解析端口名（no port name resolution），直接显示端口号而非服务名（如 `80` 而非 `http`） |



## 实战案例：解决“文件已删除但磁盘空间未释放”问题

这是一个经典问题。有时你用 `rm` 删了一个大文件，但 `df` 发现磁盘空间没回来。这是因为还有进程在打开这个文件，`rm` 只是删除了文件名索引，文件数据要等到所有进程关闭它后才会被内核真正释放。

**解决步骤：**
1.  `lsof | grep deleted`  // 查找已删除（deleted）但仍被进程持有的文件。
2.  输出会显示是哪个 **PID** 和 **COMMAND** 还在占用这个文件。
3.  你有两个选择：
    *   **重启相关进程**：`systemctl restart <service_name>`（安全选择）。
    *   **清空文件**：`echo "" > /proc/<PID>/fd/<FD>`（激进选择，直接清空文件内容释放空间，但可能影响进程）。
    *   **杀死进程**：`kill -9 <PID>`（最后的手段）。



## 总结

`lsof` 在进程管理中的作用可以概括为：

1.  **进程资源洞察**：像“进程资源监视器”一样，清晰展示进程与系统资源（文件、网络、设备）的关联关系。
2.  **系统故障排查**：是解决“设备正忙”、“端口占用”、“文件无法删除”、“磁盘空间异常”等问题的**首选工具**。
3.  **系统监控与审计**：可以查看系统整体或特定用户的资源使用情况，用于安全分析和性能排查。

**记住一个简单的口诀：当你遇到“**怎么无法...**”的问题时，第一个想到的就应该是 `lsof`，看看是不是有进程在背后占用了资源。** 它是衡量一个系统管理员水平高低的重要标志之一。
