# at

## 基础

`at` 是一个用于安排**一次性任务**在**指定时间**执行的强大命令行工具。它与 `cron` 不同，`cron` 用于安排周期性的、重复性的任务，而 `at` 则用于安排只执行一次的任务。



## 核心功能与用途

`at` 的用途是：**告诉系统“在某个时间点，执行某个任务”**。

常见的应用场景包括：
*   **计划关机**：`at 23:00` 然后输入 `shutdown -h now`，让电脑在晚上11点自动关机。
*   **避开高峰时段执行任务**：在白天安排一个耗时任务（如大数据备份、编译软件、数据处理）在夜间无人使用时执行。
*   **提醒自己**：安排一个任务在特定时间弹出消息（如使用 `notify-send` 或 `echo` 到终端）。
*   **延迟执行**：例如，让一个命令在 10 分钟后再运行。



## 基本语法与使用方法

`at` 命令的基本语法非常简单：
```bash
at [选项] 时间
```
输入这行命令后，你会进入一个特殊的交互式提示符（通常是 `at>`），此时你可以输入想要在指定时间运行的一条或多条命令。输入完成后，按 `Ctrl + D` 来保存并退出。



## 指定时间（时间格式非常灵活）

`at` 命令最强大的特性之一就是它能理解非常灵活的时间格式：

*   **标准时间格式**：
    *   `HH:MM` - 在一天中的特定时间执行（如果时间已过，则默认为第二天）。
    *   `midnight`（午夜）、`noon`（中午）、`teatime`（下午4点）。
*   **日期相关**：
    *   `MMDDYY`、`MM/DD/YY`、`DD.MM.YY` - 指定具体日期。
    *   `Jul 15`、`July 15` - 指定月份和日期。
    *   `today`（今天）、`tomorrow`（明天）。
*   **相对时间**：
    *   `now + 时间数量 时间单位` - 从现在开始的一段时间后执行。
    *   时间单位可以是：`minutes`、`hours`、`days`、`weeks`。
    *   例如：`now + 5 minutes`（5分钟后）、`now + 2 hours`（2小时后）、`now + 3 weeks`（3周后）。

**示例：**
```bash
# 今天下午4点执行
at 4:00 PM

# 明天上午10点执行
at 10am tomorrow

# 7月20日下午2点30分执行（年份默认为当前年）
at 2:30 PM Jul 20

# 15分钟后执行
at now + 15 minutes
```



## 常用选项

| 选项 | 全称     | 说明                                                         |
| :--- | :------- | :----------------------------------------------------------- |
| `-f` | `--file` | 从指定的**文件**中读取命令，而不是交互式输入。               |
| `-l` |          | 列出当前用户所有等待执行的 `at` 任务（等同于 `atq` 命令）。  |
| `-r` |          | 删除一个等待执行的 `at` 任务（等同于 `atrm` 命令）。需要任务编号。 |
| `-m` |          | 即使命令没有输出，在任务完成后也向用户发送邮件。             |
| `-M` |          | 即使命令有输出，在任务完成后也**不**向用户发送邮件。         |
| `-v` |          | 显示任务将被执行的具体时间，而不是默认的排序时间。           |

**示例：**
```bash
# 从脚本文件 job.sh 中读取命令，并在明天晚上11点执行
at -f /path/to/job.sh 11:00 PM tomorrow

# 列出所有待处理的任务
at -l
# 或使用等价的 atq
atq

# 删除编号为 5 的任务
at -r 5
# 或使用等价的 atrm
atrm 5
```



## 管理与查看任务

*   **查看队列**：使用 `atq` 或 `at -l` 可以查看当前用户所有等待执行的任务列表。输出会显示**任务编号**、执行时间、队列（queue）和用户名。
    
    ```bash
    $ atq
    10    Thu Jul 20 14:30:00 2023 a username
    5     Fri Jul 21 10:00:00 2023 a username
    ```
    
*   **删除任务**：使用 `atrm [编号]` 或 `at -r [编号]` 可以删除指定的任务。普通用户只能删除自己创建的任务。
    ```bash
    atrm 10
    ```

*   **任务执行环境**：`at` 任务会在一个**全新的 shell** 中执行，但会保留当前用户的环境变量（如 `$PATH`, `$HOME`）。工作目录（working directory）则是在执行 `at` 命令时所在的目录。



## 权限控制

出于安全考虑，系统可以通过两个文件来控制谁可以使用 `at` 命令：

*   `/etc/at.deny`：**黑名单**。在此文件中列出的用户**禁止**使用 `at` 命令。
*   `/etc/at.allow`：**白名单**（优先级更高）。如果此文件存在，**只有**在此文件中列出的用户可以使用 `at` 命令，系统会完全忽略 `/etc/at.deny`。

通常，系统默认存在 `/etc/at.deny` 文件，其中包含一些可能带来安全风险的伪用户（如 `daemon`, `bin` 等）。如果两个文件都不存在，则只有 **root** 用户可以使用 `at`。



## 注意事项

1.  **服务必须运行**：`at` 任务由一个名为 `atd` 的守护进程（daemon）负责执行。请确保它正在运行：
    ```bash
    systemctl status atd   # 查看状态
    sudo systemctl enable --now atd # 启用并立即启动（如果需要）
    ```

2.  **输出处理**：`at` 任务的标准输出和标准错误**不会**显示在你的终端上。默认情况下，系统会通过邮件（发送给任务所有者）发送给你。你可以通过在 `at` 命令中重定向输出来避免收到邮件：
    ```bash
    at now + 1 minute
    at> ls -l /home > /tmp/result.txt 2>&1
    at> <EOT> # 按 Ctrl+D
    ```

3.  **与环境交互的任务**：由于 `at` 任务在后台运行，它**无法**与桌面环境交互。例如，你不能用它来弹出图形界面的对话框（如 `zenity` 或 `notify-send` 可能无法正常工作），除非你明确指定显示环境（如 `export DISPLAY=:0`），但这通常很复杂且不可靠。对于图形界面提醒，更好的工具是 `cron` 配合正确的环境设置。

总而言之，`at` 是安排**一次性延迟任务**的完美工具，简单而高效。
