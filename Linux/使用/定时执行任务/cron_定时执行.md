# Cron

## 基础

**Cron** 是一个在类 Unix 系统（包括 Linux 和 macOS）中运行的**守护进程**（后台服务），用于在指定的日期和时间周期性地执行预定的命令或脚本。它的名字来源于希腊语“chronos”，意为时间。

简单来说，Cron 就是 Linux 系统的**“计划任务”**或**“自动化工具”**。你可以用它来让系统在每天、每周、每月或每年的特定时间自动完成各种任务，而无需手动干预。



## Cron 的核心组成

Cron 系统主要由三部分组成：

1.  **`crond` 守护进程**：
    这是一个始终在后台运行的服务。它的任务就是每分钟醒来一次，检查是否有需要执行的计划任务，如果有就触发它。

2.  **Cron 表（Crontab）文件**：
    这是真正定义“在什么时间做什么事”的配置文件。它不是一个单一的大文件，而是每个用户（包括 root）都可以拥有自己的 crontab 文件。
    *   **系统级 Crontab**：通常位于 `/etc/crontab` 和 `/etc/cron.d/` 目录，用于系统级别的任务（需要 root 权限）。
    *   **用户级 Crontab**：每个用户的个人计划任务列表，存储在 `/var/spool/cron/` 目录中（不建议直接编辑）。

3.  **`crontab` 命令**：
    这是用户用来创建、编辑、查看和删除自己 cron 任务的命令。**永远不要直接用手动编辑器（如 vim）去编辑 `/var/spool/cron/` 下的文件**，而应该使用 `crontab` 命令。



## 如何使用 `crontab` 命令？

| 命令                   | 作用                                               | 示例                      |
| :--------------------- | :------------------------------------------------- | :------------------------ |
| crontab -e             | **编辑**当前用户的 cron 任务表。这是最常用的命令。 | `crontab -e`              |
| crontab -l             | **列出**当前用户的所有 cron 任务。                 | `crontab -l`              |
| crontab -r             | **删除**当前用户的所有 cron 任务。（**慎用！**）   | `crontab -r`              |
| crontab -u username -e | 编辑**指定用户**的 cron 任务（需要 root 权限）。   | `sudo crontab -u root -e` |

当你第一次运行 `crontab -e` 时，它会让你选择一个默认的文本编辑器（如 nano 或 vim）。



## Crontab 的语法格式

Crontab 文件的每一行都是一个独立的任务（一个“cron job”），其格式如下：

```
# ┌───────────── 分钟 (0 - 59)
# │ ┌───────────── 小时 (0 - 23)
# │ │ ┌───────────── 一个月中的第几天 (1 - 31)
# │ │ │ ┌───────────── 月 (1 - 12)
# │ │ │ │ ┌───────────── 一周中的第几天 (0 - 7)（0 和 7 都代表周日）
# │ │ │ │ │
# │ │ │ │ │
# * * * * * <要执行的命令>
```

**时间字段说明：**

| 字段 | 含义                | 取值范围                                          |
| :--- | :------------------ | :------------------------------------------------ |
| 1    | 分钟（Minute）      | `0` - `59`                                        |
| 2    | 小时（Hour）        | `0` - `23`                                        |
| 3    | 日（Day of month）  | `1` - `31`                                        |
| 4    | 月（Month）         | `1` - `12` (或 `JAN` - `DEC`)                     |
| 5    | 星期（Day of week） | `0` - `7` (`0` 和 `7` 都是周日，或 `SUN` - `SAT`) |
| 6    | 要执行的命令        | 任何可以在命令行中执行的命令                      |

**特殊字符说明：**

| 符号 | 含义                 | 示例                                                         |
| :--- | :------------------- | :----------------------------------------------------------- |
| `*`  | 代表“所有”可能的值。 | `* * * * *` 每分钟执行一次                                   |
| `,`  | 指定一个列表。       | `0 9,18 * * *` 每天上午9点和下午6点各执行一次                |
| `-`  | 指定一个范围。       | `0 9-17 * * *` 每天上午9点到下午5点，每小时执行一次（9点，10点，...，17点） |
| `/`  | 指定间隔频率。       | `*/10 * * * *` 每10分钟执行一次                              |

**特殊字符串（@）：**

为了方便，cron 还提供了一些快捷的别名：

| 字符串                   | 含义                 | 等价于      |
| :----------------------- | :------------------- | :---------- |
| `@yearly` 或 `@annually` | 每年执行一次         | `0 0 1 1 *` |
| `@monthly`               | 每月执行一次         | `0 0 1 * *` |
| `@weekly`                | 每周执行一次         | `0 0 * * 0` |
| `@daily`                 | 每天执行一次         | `0 0 * * *` |
| `@hourly`                | 每小时执行一次       | `0 * * * *` |
| `@reboot`                | 在系统启动时执行一次 | 无时间字段  |



## 实用示例

```bash
# 每天凌晨2点30分执行一个备份脚本
30 2 * * * /home/user/scripts/backup.sh

# 每周一上午9点，清空临时文件夹
0 9 * * 1 rm -rf /tmp/*

# 在工作日（周一到周五）的下午5点，发送一封邮件
0 17 * * 1-5 echo "下班时间到了！" | mail -s "提醒" user@example.com

# 每5分钟检查一次磁盘空间（注意转义 %）
*/5 * * * * /usr/bin/df -h > /tmp/disk_report.txt

# 每月1号的凌晨0点，重启某个服务（例如nginx）
0 0 1 * * systemctl restart nginx

# 使用特殊字符串：每天午夜执行日志轮转
@daily /usr/sbin/logrotate /etc/logrotate.conf

# 系统启动时运行一个脚本
@reboot /home/user/scripts/startup_job.sh
```



## 重要的注意事项和最佳实践

1.  **环境变量**：Cron 执行任务时的环境与你的用户 Shell 环境**不同**。它通常只有最精简的环境变量（如 `PATH`）。因此，在脚本中使用**绝对路径**是最安全的选择。
    *   **错误**：`myscript.sh`
    *   **正确**：`/home/user/scripts/myscript.sh`

2.  **输出处理**：Cron 默认会通过电子邮件将命令的任何输出（stdout 或 stderr）发送给任务所属的用户。如果不想收到邮件，可以将输出重定向：
    
    *   `> /dev/null 2>&1`：丢弃所有输出（静默执行）。
    *   `>> /path/to/logfile 2>&1`：将输出追加到日志文件。
    
    ```bash
    # 示例：静默执行
    */10 * * * * /path/to/script.sh > /dev/null 2>&1
    
    # 示例：记录日志
    */10 * * * * /path/to/script.sh >> /var/log/myjob.log 2>&1
    ```
    
3.  **调试技巧**：
    *   如果任务没有按预期执行，首先检查命令在命令行中是否能**直接运行**。
    *   查看 Cron 的日志文件来排查问题。日志通常在 `/var/log/cron`、`/var/log/syslog` 中，可以使用 `grep` 过滤：
        ```bash
        grep CRON /var/log/syslog
        # 或者
        journalctl -u cron.service
        ```

## 总结

Cron 是 Linux 系统自动化管理的基石，无论是系统维护（如备份、日志轮转、更新）还是个人自动化（如定时下载、提醒），它都是一个不可或缺的强大工具。掌握 Cron 的使用，能极大提升你的系统管理效率和可靠性。
