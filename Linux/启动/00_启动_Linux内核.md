# Linux内核启动

## BIOS/UEFI阶段

这是内核启动之前的准备工作，由固件完成。

1.  **通电，执行POST（Power-On Self-Test）**：
    *   计算机通电后，主板上的固件（BIOS或现代的UEFI）开始运行。
    *   进行**硬件自检**，检测关键硬件（如CPU、内存、磁盘、显卡）是否正常工作。

2.  **初始化硬件**：
    *   固件初始化硬件设备，为其设置基本运行环境。

3.  **选择启动设备**：
    *   根据配置的启动顺序（Boot Order），找到第一个可引导的存储设备（如硬盘、U盘）。

4.  **加载引导程序（Bootloader）**：
    *   从启动设备的**第一个扇区（MBR）** 或**EFI系统分区（ESP）** 中读取**引导程序**（如GRUB）的**第一阶段**代码到内存。
    *   随后将控制权交给这段代码。引导程序会加载更多复杂的代码，最终显示 boot menu。



## 引导加载程序阶段（GRUB等）

引导程序的核心任务是**加载Linux内核映像（vmlinuz）和初始内存磁盘（initramfs）** 到内存中，并为内核设置好启动参数。

1.  **加载内核映像**：
    *   引导程序（如GRUB）从文件系统（如ext4, XFS）中找到 `vmlinuz` 文件。这是一个压缩过的可执行文件。
    *   将其从磁盘加载到内存的特定地址。

2.  **加载initramfs**：
    *   加载 `initramfs` 文件到内存。这是一个临时的根文件系统镜像，包含了在内核启动早期所必需的**驱动程序和工具**（例如用于访问真正根文件系统的SATA、NVMe、LVM、文件系统驱动等）。
    *   它的存在是为了解决“鸡生蛋还是蛋生鸡”的问题：内核需要驱动来访问根文件系统，但驱动又存放在根文件系统中。

3.  **设置启动参数**：
    *   引导程序将命令行参数（如根设备`root=`、只读`ro`等）传递给内核。

4.  **跳转到内核入口点**：
    *   所有准备工作就绪后，引导程序跳转到内核在内存中的入口地址，将控制权**彻底交给Linux内核**。



## 内核自身初始化阶段

这是内核开始执行其代码的阶段，又分为架构相关和架构无关两部分。

1.  **架构特定设置**：
    *   内核首先会执行与CPU架构高度相关的代码（通常在 `arch/x86/boot/` 目录下）。
    *   它会初始化控制台、检测CPU型号、启用内存管理单元（MMU）、设置内存分页等，为进入保护模式做准备。
    *   如果内核是压缩的（通常是`zImage`或`bzImage`），它会**先进行自解压**。

2.  **通用内核初始化（start_kernel()）**：
    *   解压后，内核进入架构无关的通用初始化阶段，这是所有Linux平台共通的。这个过程的入口是 `start_kernel()` 函数（在 `init/main.c` 中）。这是一个极其重要的函数，它初始化了内核的所有核心子系统，可以看作是Linux内核的`main()`函数。它主要完成：
        *   **初始化调度器**： 为所有CPU初始化进程调度器。
        *   **初始化内存管理**： 初始化伙伴系统（Buddy System）和slab分配器，以便之后能高效地管理内存。
        *   **初始化虚拟文件系统（VFS）**： 为后续支持各种文件系统打下基础。
        *   **初始化各种子系统**： 如网络栈、RCU、中断请求（IRQ）、定时器等。
        *   **创建第一个内核线程**： 创建第一个进程——`init_task`（即0号进程`swapper`，它负责空闲CPU时间的管理）。
        *   **创建1号用户进程（init）的雏形**： 内核线程`kernel_init`被创建，它最终将尝试切换到用户空间。

3.  **挂载根文件系统**：
    *   内核会尝试挂载真正的根文件系统（`/`）。它使用`initramfs`中提供的驱动和工具来访问根设备。
    *   一旦真正的根文件系统被成功挂载，内核就会**卸载并释放`initramfs`** 所占用的内存。



## 启动用户空间Init进程（PID 1）

内核初始化完所有硬件和核心子系统后，其自身的工作就基本完成了。它需要找到一个**第一个运行在用户空间（User Space）的程序**，并将控制权交给它，由它来负责启动所有其他的用户进程。

1.  **执行/sbin/init**：
    *   内核会按照预定义的列表（如`/sbin/init`, `/etc/init`, `/bin/init`等）寻找第一个可执行的Init程序。
    *   现代绝大多数Linux发行版使用的Init系统是 **systemd**。它的二进制文件通常是 `/usr/lib/systemd/systemd`，但会有一个符号链接到 `/sbin/init`。
    *   这个Init进程是系统所有进程的**始祖**，它的进程号（PID）**永远是1**。

2.  **Init系统接管**：
    *   **systemd**（或SysVinit）开始执行，它负责启动系统的其余部分：
        *   运行各种启动服务（Service）。
        *   挂载`/etc/fstab`中定义的文件系统。
        *   切换到预定的运行级别（Runlevel）或目标（Target，如`multi-user.target`或`graphical.target`）。
        *   最终，它会启动登录管理器（如GDM, LightDM）或getty登录终端，等待用户登录。



## 总结

Linux内核的启动顺序可以精炼地概括为：

- **BIOS/UEFI**
- **Bootloader (GRUB)**
- **加载内核和initramfs**
- **内核解压和架构特定初始化**
- **start_kernel()初始化核心子系统**
- **挂载根文件系统**
- **启动第一个用户空间进程Init (PID 1: systemd)**
- **Init系统启动所有服务**
- **用户登录，系统就绪。**

