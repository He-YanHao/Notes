# PAM

## 基础

**PAM**（**P**luggable **A**uthentication **M**odules，可插拔认证模块）是一个强大的系统级库，用于统一和管理各种应用程序的认证（Authentication）过程。

**核心思想**：将应用程序的认证逻辑与具体的认证机制分离开来。

在 PAM 出现之前，每个需要认证的程序（如 `login`, `su`, `ftp` 等）都需要硬编码（hard-code）自己的认证方式（比如直接读取 `/etc/passwd` 和 `/etc/shadow`）。如果想增加新的认证方法（如使用指纹、智能卡或 LDAP），就必须修改每个程序的源代码并重新编译，非常繁琐且不安全。

PAM 通过提供一个共享库和一套统一的 API 解决了这个问题。现在，应用程序只需要简单地调用 PAM API 并说“请验证这个用户”，而具体的验证工作（如何验证、用什么规则验证）则交给 PAM 动态加载的模块来决定。



## PAM特点

1.  **灵活性**：系统管理员可以像搭积木一样，通过堆叠（stack）不同的 PAM 模块来为不同的服务定制极其复杂的认证策略，而无需改动任何应用程序的代码。
2.  **标准化**：所有支持 PAM 的应用程序都使用同一套认证流程，简化了管理和配置。
3.  **强大功能**：PAM 不仅能处理密码验证（认证），还能管理账户权限、会话设置和密码修改，提供了身份验证的完整生命周期管理。



## PAM 的四大管理组类型

PAM 配置文件将认证过程分为四种不同类型的管理组：

| 类型         | 作用                                                   | 经典问题                                                     |
| :----------- | :----------------------------------------------------- | :----------------------------------------------------------- |
| **auth**     | **认证**：验证用户身份的真实性。                       | “你是你是谁吗？”（例如，验证密码）                           |
| **account**  | **账户管理**：检查账户是否拥有访问权限。               | “你被允许登录吗？”（例如，检查账户是否过期、是否在允许时间段内登录） |
| **password** | **密码管理**：更新用户的认证令牌（如密码）。           | “你想修改密码吗？”（例如，`passwd` 命令使用的模块）          |
| **session**  | **会话管理**：在用户认证成功前后，设置和清理会话环境。 | “登录前/后需要为你准备/清理什么？”（例如，挂载用户家目录、记录登录日志） |

一个完整的认证流程通常会依次经过这四个阶段。



## PAM 配置文件在哪里

PAM 的配置文件主要位于 `/etc/pam.d/` 目录下，**每个需要 PAM 认证的应用程序都有一个与自己同名的配置文件**。

*   `/etc/pam.d/login`：控制本地终端登录。
*   `/etc/pam.d/sshd`：控制 SSH 远程登录。
*   `/etc/pam.d/su`：控制 `su` 命令。
*   `/etc/pam.d/sudo`：控制 `sudo` 命令。
*   `/etc/pam.d/passwd`：控制 `passwd` 命令。

还有一个古老的通用配置文件 `/etc/pam.conf`，但现代系统通常优先使用 `/etc/pam.d/` 目录。



## 配置文件语法详解

每个 PAM 配置文件由一行行的规则组成。每条规则的语法如下：

`<管理组类型> <控制标志> <模块路径> <模块参数>`

**示例**（来自 `/etc/pam.d/common-auth`）：
```
auth    required    pam_unix.so    try_first_pass nullok
```

1.  **管理组类型**：即 `auth`, `account`, `password`, `session` 之一。
2.  **控制标志**：告诉 PAM 如果该模块执行成功或失败，该如何影响整个认证流程。这是最核心的概念。
    | 控制标志     | 含义     | 工作方式                                                     |
    | :----------- | :------- | :----------------------------------------------------------- |
    | `required`   | **必需** | 模块必须成功。如果失败，最终一定会失败，但会等所有模块都执行完再报错。 |
    | `requisite`  | **必要** | 模块必须成功。如果失败，**立即终止**认证过程并返回失败。**安全性更高**。 |
    | `sufficient` | **足够** | 如果此模块成功，且之前没有 `required` 失败，则立即返回成功，跳过后续同类模块。 |
    | `optional`   | **可选** | 该模块的成功与否通常不影响整体结果（除非它是该类型中唯一的模块）。 |
    | `include`    | **包含** | 将其他配置文件中的所有规则包含到当前位置。例如 `@include common-auth`。 |

3.  **模块路径**：要调用的 PAM 模块的完整路径（如 `/lib/security/pam_unix.so`）或相对路径（如 `pam_unix.so`），系统会在默认模块目录中查找。
4.  **模块参数**：传递给模块的特定选项，用于调整其行为（如 `nullok` 允许空密码）。



## 解读 `sudo` 的 PAM 配置

让我们看一下 `/etc/pam.d/sudo` 的一个常见配置：

```
#%PAM-1.0
auth       required   pam_env.so
auth       required   pam_unix.so
account    required   pam_unix.so
session    required   pam_unix.so
```

1.  **`auth ... pam_env.so`**：设置环境变量。
2.  **`auth ... pam_unix.so`**：要求用户输入**自己的密码**进行认证。
3.  **`account ... pam_unix.so`**：检查用户的账户状态是否有效（未过期等）。
4.  **`session ... pam_unix.so`**：为此次 `sudo` 会话设置必要的环境。



## 常用 PAM 模块简介

| 模块               | 功能描述                                                     |
| :----------------- | :----------------------------------------------------------- |
| `pam_unix.so`      | **核心模块**，使用标准的 `/etc/passwd` 和 `/etc/shadow` 进行认证。 |
| `pam_deny.so`      | **总是返回失败**。用于拒绝访问。                             |
| `pam_permit.so`    | **总是返回成功**。用于允许访问（极其不安全，慎用）。         |
| `pam_cracklib.so`  | **密码强度检查**，在修改密码时检查新密码是否过于简单或存在于字典中。 |
| `pam_tally2.so`    | **登录尝试计数器**，实现账户锁定功能。多次密码错误后锁定账户，防止暴力破解。 |
| `pam_limits.so`    | **资源限制**，通过 `/etc/security/limits.conf` 限制用户可使用的系统资源（如最大进程数、文件打开数等）。 |
| `pam_motd.so`      | **显示今日消息**（Message of the Day），用户登录后显示 `/etc/motd` 内容。 |
| `pam_securetty.so` | 限制 **root** 用户只能从安全的 TTY（终端）登录。             |
| `pam_listfile.so`  | 根据**指定文件**的内容来允许或拒绝访问，非常灵活。           |
| `pam_sss.so`       | 与 **SSSD** 集成，用于连接中央身份管理系统（如 Active Directory, FreeIPA）。 |



## 调试与故障排除

如果配置出错（例如错误地编辑了 `/etc/pam.d/common-auth`），可能会导致**所有用户无法登录**的严重故障。

**安全网**：始终保持至少一个 **root shell** 会话打开，并且在确认新配置工作正常之前**不要退出**。这样如果配置出错，你还可以在原来的会话中恢复更改。

**查看日志**：PAM 相关的日志通常记录在 `/var/log/auth.log`（Debian/Ubuntu）或 `/var/log/secure`（RHEL/CentOS）中。配置出错时，这里是寻找线索的第一现场。



## 总结

PAM 是 Linux 系统安全和身份验证的幕后英雄。它提供了一个高度灵活、可配置的框架，使得系统管理员能够：

*   **为不同服务设置不同的认证策略**（如 SSH 使用双因子认证，而本地登录不需要）。
*   **轻松集成新的认证技术**（如指纹、智能卡、LDAP、AD）。
*   **实施安全策略**（如强密码策略、登录失败锁定、访问时间限制）。

理解 PAM 是成为高级 Linux 系统管理员的关键一步。当你需要修改登录、认证、资源限制等行为时，你最终都会与 `/etc/pam.d/` 目录下的文件打交道。



