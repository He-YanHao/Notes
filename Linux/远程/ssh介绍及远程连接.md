# ssh

## 基础介绍

ssh（**S**ecure **Sh**ell）是一种网络协议，用于通过一条不安全的网络（如互联网）在两个设备之间建立一条**加密的、安全的**通信通道。它是为了替代那些以明文方式传输数据（包括密码）的不安全协议（如 Telnet、rlogin）而创建的。

ssh 最主要、最经典的用途是**安全地登录到一台远程服务器或计算机，并执行命令或进行操作**。系统管理员几乎每天都会使用它来管理分布在世界各地的服务器。





## 作用

1.  **安全文件传输**：通过相关的工具如 `scp` (Secure Copy) 和 `sftp` (SSH File Transfer Protocol)。
2.  **端口转发（隧道）**：
    *   **本地端口转发**：让你能够通过远程服务器访问另一个受保护内部网络中的服务。
    *   **远程端口转发**：让外部网络能够访问你本地网络中的服务。
    *   **动态端口转发**：创建一个本地的 SOCKS 代理服务器，将所有流量通过远程服务器转发，常用于科学上网。
3.  **代理和跳板**：使用 `-J` 选项或 `ProxyJump` 配置，通过一台“跳板机”连接到另一台无法直接访问的内网机器。
4.  **执行远程命令**：无需登录交互式 shell，直接远程执行一条命令并获取结果，常用于自动化脚本。例如：`ssh user@host 'ls -l /tmp'`。
5.  **Git 操作**：Git 版本控制通过 SSH 协议与远程仓库（如 GitHub, GitLab）进行安全的认证和数据传输。





## 为什么是安全的？

其安全性建立在两大基石上：

1.  **加密**：在客户端和服务器建立连接后，所有传输的数据（包括用户名、密码、执行的命令及其输出）都会经过加密。即使数据包在传输过程中被截获，攻击者也无法读懂其内容。
2.  **认证**：SSH 提供了多种方式来验证客户端的身份，确保只有授权用户才能访问服务器。
    *   **密码认证**：使用服务器上用户的密码进行验证。（**注意**：虽然密码本身通过加密通道传输，但仍可能被暴力破解，因此不是最安全的方式）。
    *   **公钥认证**：这是**更推荐、更安全**的方式。它使用一对加密密钥：一个**私钥**（严格保密，存放在客户端机器上）和一个**公钥**（可以公开，存放在远程服务器的 `~/.ssh/authorized_keys` 文件中）。登录时，客户端用私钥证明自己的身份，无需传输密码。



## ssh远程连接必备条件

需要 `openssh-server` 组件，检查是否安装。

```shell
sudo apt install openssh-server
```

检查是否启动

```shell
sudo systemctl status ssh
```

如果没有启动，使用：

```shell
sudo systemctl enable --now ssh
```

启动，并设置为开机自启动。

更改防火墙配置，防止防火墙拦截ssh连接请求。

```shell
sudo ufw allow ssh
# 或者直接允许22端口
sudo ufw allow 22
```



## 基本命令语法

最基本的连接命令如下：

```bash
ssh [参数] [user@]hostname [command]
```

*   `user@`：指定远程主机上的用户名。如果省略，SSH 会尝试使用你本地当前的用户名进行登录。
*   `hostname`：远程服务器的主机名或 IP 地址。
*   `command`：（可选）如果提供，则直接执行该命令而非启动交互式 shell。

**常用参数**：

*   `-p <port>`：指定连接远程服务器的端口号（默认为 22）。
*   `-i <identity_file>`：指定要使用的私钥文件。
*   `-X`：启用 X11 转发，可以在远程运行图形界面程序并显示在你的本地电脑上。
*   `-L`, `-R`, `-D`：用于各种端口转发。
*   `-v`：详细模式（输出调试信息），用于排查连接问题。`-vvv` 输出更详细的信息。





## 基本使用示例

### 使用密码登录

```bash
ssh username@192.168.1.100
# 或
ssh -p 2222 username@example.com # 连接到非标准端口
```



### 使用公钥认证（无需密码）

1. 将公钥上传到服务器

```bash
ssh-copy-id -i ~/.ssh/id_ed25519.pub username@hostname
```
之后再次登录就不再需要输入密码了。



## 安全最佳实践

1.  **禁用密码登录**：在服务器配置中 (`/etc/ssh/sshd_config`) 设置 `PasswordAuthentication no`，强制使用密钥认证，从根本上杜绝暴力破解密码的可能。
2.  **禁用 root 用户直接登录**：设置 `PermitRootLogin no`，先用普通用户登录，再通过 `su` 或 `sudo` 切换权限。
3.  **使用非标准端口**：修改 `Port 22` 为其他端口，可以减少自动化脚本的扫描和攻击。
4.  **使用强加密算法和密钥**：现在推荐使用 `ed25519` 算法，而非旧的 `RSA`（如果使用 RSA，密钥长度至少为 4096 位）。
5.  **使用防火墙**：使用 `fail2ban` 等工具自动封锁多次尝试登录失败的 IP 地址。

**总结**：SSH 是连接和管理远程系统的基石，是每一位开发者、系统管理员乃至IT爱好者都必须掌握的核心工具。它提供的安全性和灵活性是无与伦比的。



