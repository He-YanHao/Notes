# BMP


BMP（全称 Bitmap）是 Window 操作系统中的标准图像文件格式，文件后缀名为“.bmp”， 使用非常广。它采用位映射存储格式，除了图像深度可选以外，不采用其他任何压缩，因此， BMP 文件所占用的空间很大，但是没有失真。 BMP 文件的图像深度可选 lbit、 4bit、 8bit、 16bit、 24bit 及 32bit。 BMP 文件存储数据时，图像的扫描方式是按从左到右、从下到上的顺序。

bmp文件大体上分成四个部分：

1. 位图头文件数据结构，包含 BMP 图像文件的类型、显示内容等信息；
2. 位图信息数据结构，包含有 BMP 图像的宽、高、压缩方法，以及定义颜色等信息
3. 调色板，这个部分是可选的，有些位图需要调色板，有些位图，比如真彩色图（24 位
    的 BMP）就不需要调色板；
4. 位图数据，这部分的内容根据 BMP 位图使用的位数不同而不同，在 24 位图中直接使
    用 RGB，而其他的小于 24 位的使用调色板中颜色索引值。

## 文件结构

首先需要知道在BMP文件中，**所有多字节数值都采用小端序存储**，这意味着：

-   **最低有效字节在前，最高有效字节在后**

### 位图文件头

第一部分为位图文件头 BITMAPFILEHEADER，是一个结构，其定义如下：

```c
#pragma pack(push, 1)
typedef struct {
    uint16_t bfType;          // "BM" - 0x4D42 
    uint32_t bfSize;          // 文件总大小
    uint16_t bfReserved1;     // 保留 = 0
    uint16_t bfReserved2;     // 保留 = 0
    uint32_t bfOffBits;       // 数据区偏移量
} BMP_FileHeader;
```

例如：

```c
//42 4D
//36 24 00 00
//00 00
//00 00
//36 00 00 00
```

这个结构的长度是固定的，为 14 个字节（WORD 为无符号 16 位整数，DWORD 为无符号 32 位整数）。

各个域的说明如下：

1. bfType  指定文件类型，必须是 0x424D，即字符串"BM"，也就是说所有.bmp 文件的头两个字节都 是"BM"  
2. bfSize  指定包括这 14 个字节在内的文件大小，占4个字节。
3. bfReserved1，bfReserved2  为保留字，不用考虑。
4. bfOffBits为从文件头到实际的位图数据的偏移字节数。

### 位图信息头

第二部分为位图信息头 BITMAPINFOHEADER，也是一个结构，其定义如下：  

```c
typedef struct {
    uint32_t biSize;          // 信息头大小 = 40
    int32_t  biWidth;         // 图像宽度
    int32_t  biHeight;        // 图像高度（正数表示倒向）
    uint16_t biPlanes;        // 颜色平面数 = 1
    uint16_t biBitCount;      // 每像素位数
    uint32_t biCompression;   // 压缩类型 = 0 (BI_RGB)
    uint32_t biSizeImage;     // 图像数据大小
    int32_t  biXPelsPerMeter; // 水平分辨率 = 0
    int32_t  biYPelsPerMeter; // 垂直分辨率 = 0
    uint32_t biClrUsed;       // 使用的颜色数 = 0
    uint32_t biClrImportant;  // 重要颜色数 = 0
} BMP_InfoHeader;
```

例如：

```c
//28 00 00 00   //固定为40
//30 00 00 00   //48像素
//30 00 00 00   //48像素
//01 00         //颜色平面数 = 1
//20 00         //色彩深度 = 0x0020 = 32位
//00 00 00 00   //压缩方式 = 0（不压缩）
//00 24 00 00   //像素数据大小=0x00002400=9216字节
//C3 0E 00 00   //水平分辨率
//C3 0E 00 00   //垂直分辨率
//00 00 00 00   //使用的颜色数 = 0（使用全部）
//00 00 00 00   //重要颜色数 = 0（全部重要）
```

这个结构的长度是固定的，为 40 个字节。

各个域的说明如下：  

1. biSize  指定这个结构的长度，为 40。

2. biWidth  指定图象的宽度，单位是象素。

3. biHeight  指定图象的高度，单位是象素。。

    biHeight 可以是正数（图像倒置存储，原点在左下角）或负数（图像正立存储，原点在左上角，更常见）。

4. biPlanes  为目标设备说明位面数，必须是 1，不用考虑。

5. biBitCount  指定表示颜色时要用到的位数，常用的值为：

    -   1：黑白二色图
    -   4：16 色图
    -   8：256 色
    -   16：高彩色位图，通常用5-6-5格式（R5G6B5）表示一个像素。
    -   24：真彩色图
    -   32： 带Alpha通道的真彩色位图，每个像素用4字节表示，通常为蓝(B)、绿(G)、红(R)、Alpha(A)

6. biCompression  指定位图是否压缩，有效的值为 BI_RGB，BI_RLE8，BI_RLE4，BI_BITFIELDS（都是一 些 Windows 定义好的常量）。

    -  BI_RGB：没有压缩。
    -  BI_RLE8：每个象素8比特的RLE压缩编码，压缩格式由2字节组成(重复象素计数和颜色索引)。
    -  BI_RLE4：每个象素4比特的RLE压缩编码，压缩格式由2字节组成。
    -  BI_BITFIELDS：每个象素的比特由指定的掩码决定。

    -  要说明的是，Windows 位图可以采用 RLE4，和 RLE8 的压缩 格式，但用的不多。我们今后所讨论的只有第一种不压缩的情况，即biCompression为BI_RGB 的情况。    

7. biSizeImage  指定实际的位图数据占用的字节数，当用BI_RGB格式时，可设置为0。其实也可以从以下的公式中计算出来：  biSizeImage=biWidth'*biHeight  要注意的是：上述公式中的 biWidth'必须是 4 的整倍数（所以不是 biWidth，而是 biWidth'， 表示大于或等于 biWidth 的，离 4 最近的整倍数。举个例子，如果 biWidth=240，则 biWidth'=240；如果 biWidth=241，biWidth'=244）。

8. biXPelsPerMeter  指定目标设备的水平分辨率，单位是每米的象素个数。

9. biYPelsPerMeter  指定目标设备的垂直分辨率，单位同上。  

10. biClrUsed  指定本图象实际用到的颜色数，如果该值为零，则用到的颜色数为 2 的 biBitCount 次方。

11. biClrImportant  指定本图象中重要的颜色数，如果该值为零，则认为所有的颜色都是重要的。

### 调色板

第三部分为调色板/调色盘(Palette)，当然，这里是对那些需要调色板的位图文件而言的。有些位图， 如真彩色图，前面已经讲过，是不需要调色板的，BITMAPINFOHEADER 后直接是位图数据。  

是一个**可选**的结构。

只有当 `biBitCount` ≤ 8 时才存在。

它本质上是一个数组形式的颜色查询表，每个条目是一个 **RGBQUAD** 结构（4字节）。

```C
typedef struct tagRGBQUAD
{  
    BYTE rgbBlue;     //该颜色的蓝色分量
    BYTE rgbGreen;    //该颜色的绿色分量
    BYTE rgbRed;      //该颜色的红色分量
    BYTE rgbReserved; //保留值，设置为0。
} RGBQUAD;
```

### 图象数据

第四部分就是实际的图象数据了。

存储了图像的原始像素阵列。

采用**扫描行对齐**： 每个水平行的像素数据，其字节数必须是**4的倍数**。如果不够，需要在行末进行**填充（Padding）**，填充字节的值通常为0。

一般来说，`.BMP` 文件的数据从下到上，从左到右的。也就是说，从文件中最先读到的 是图象最下面一行的左边第一个像素，然后是左边第二个像素… 接下来是倒数第二行左边第 一个像素，左边第二个像素…依次类推，最后得到的是最上面一行的最右一个像素。

对于用到调色板的位图，图象数据就是该像素颜在调色板中的索引值，对于真彩色图，图象数据就是实际的 R,G,B 值。

下面就 2 色，16 色，256 色位 图和真彩色位图分别介绍：

- 对于 2 色位图，用 1 位就可以表示该像素的颜色（一般 0 表示黑，1 表示白），所以一个字 节可以表示 8 个像素。  
- 对于 16 色位图，用 4 位可以表示一个像素的颜色，所以一个字节可以表示 2 个像素。  
- 对于 256 色位图，一个字节刚好可以表示 1 个像素。  
- 对于真彩色图，三个字节才能表示 1 个像素。  

