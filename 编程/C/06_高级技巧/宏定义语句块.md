

# 宏定义语句块

可以用宏定义替换多行代码伪装成为函数。

例如：

```c
#define OPERATION(obj, num)       \
    do {                                          \
        if ((obj) == NULL) {                      \
            return ESP_FAIL;                      \
        }                                         \
		/* 具体操作 */                              \
        return ESP_OK;                            \
    } while (0)
```

可以伪装出等效的函数。

```c
OPERATION(obj,num)
```

这样写的优点有

-   不对传入参数进行类型检查，可以更加通用。
-   可以代替调用者进行函数返回。
-   节省开销，仅仅是在编译是展开语句，不构成函数之间的跳转，这点开销很小，但嵌入式环境不可忽视。



非常关键的一点：为什么一定要 `do { ... } while (0)` ？

假设是：

```c
#define OPERATION(obj, num)       \
	if ((obj) == NULL) {          \
		return ESP_FAIL;          \
	}                             \
	/* 具体操作 */                 \
	return ESP_OK;                            
```

看上去没问题，但是下面的函数完成替换

```c
if (cond)
    OPERATION(...);
else
    ...
```

会变成

```c
if (cond)
    if ((obj) == NULL)
    {
        return ESP_FAIL;
    }
	/* 具体操作 */
	return ESP_OK;;
else
    ...
```

毫无疑问，宏替换的内容不成为一个整体，而且结尾多了一个分号`;` 。

如果使用 `{}` 代替：

```c
if (cond)
    {
    	if ((obj) == NULL)
        {
        	return ESP_FAIL;
    	}
    /* 具体操作 */
    return ESP_OK;
	};
else
    ...
```

只解决了宏替换的内容不成为一个整体的问题，结尾依旧多了一个分号`;` 。





 













