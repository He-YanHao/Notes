# 字符串类QString

Qt 提供了自己强大的字符串类 `QString`，它比标准 C++ 的 `std::string` 功能更丰富，特别适合处理 Unicode 文本和国际化应用程序。

## QString 概述

### 基本特性
- **Unicode 支持**：QString 存储 UTF-16 编码的 Unicode 字符
- **隐式共享**（写时复制）：高效内存管理，多个 QString 对象可共享同一数据
- **引用计数**：自动内存管理，无需手动释放
- **丰富的 API**：提供了大量便捷的字符串操作方法

### 与标准字符串对比
| 特性         | QString           | std::string                  |
| ------------ | ----------------- | ---------------------------- |
| 编码         | UTF-16            | 依赖本地编码（通常 Latin-1） |
| 内存管理     | 引用计数+隐式共享 | 通常使用 COW（写时复制）     |
| Unicode 支持 | 原生支持          | 需要 std::wstring 或转换     |
| 方法数量     | 非常丰富          | 相对较少                     |
| 平台一致性   | 跨平台行为一致    | 可能因平台而异               |

## 创建和初始化 QString

**空字符串**

```cpp
QString emptyStr;
```

**从C字符串创建**

```cpp
QString str1 = "Hello World";
QString str2("Hello Qt");
```

**从宽字符创建**


```cpp
QString str3 = QString::fromWCharArray(L"宽字符文本");
```

**从数字创建**


```cpp
QString str4 = QString::number(42);        // "42"
QString str5 = QString::number(3.14);      // "3.14"
```

**使用格式化创建**


```cpp
QString str6 = QString("Value: %1, Name: %2").arg(123).arg("Alice");
```

**重复字符**


```cpp
QString str7 = QString(5, 'A');            // "AAAAA"
```

从其他编码创建

```cpp
QString str8 = QString::fromUtf8("UTF-8文本");
QString str9 = QString::fromLatin1("Latin1文本");
```

## 常用操作和方法

### 字符串连接
```cpp
QString s1 = "Hello";
QString s2 = "World";

// 使用 + 运算符
QString result1 = s1 + " " + s2;           // "Hello World"

// 使用 append()
QString result2 = s1;
result2.append(" ").append(s2);             // "Hello World"

// 使用 sprintf 风格
QString result3 = QString("%1 %2").arg(s1).arg(s2); // "Hello World"
```

### 字符串查询
```cpp
QString str = "Hello World";

// 获取长度
int len = str.length();                     // 11
int size = str.size();                      // 11

// 检查是否为空
bool isEmpty = str.isEmpty();               // false

// 检查是否包含子串
bool contains = str.contains("Hello");      // true

// 查找位置
int index = str.indexOf("World");           // 6
int lastIndex = str.lastIndexOf("l");       // 9

// 比较字符串
int cmp = QString::compare("abc", "ABC");   // 不区分大小写比较
int cmp2 = QString::compare("abc", "ABC", Qt::CaseSensitive); // 区分大小写
```

### 字符串修改
```cpp
QString str = "Hello World";

// 替换
str.replace("World", "Qt");                 // "Hello Qt"

// 插入
str.insert(5, " Beautiful");               // "Hello Beautiful World"

// 移除
str.remove(5, 10);                         // "Hello"

// 截取
QString left = str.left(5);                 // "Hello"
QString right = str.right(5);               // "World"
QString mid = str.mid(6, 5);                // "World"

// 大小写转换
QString upper = str.toUpper();              // "HELLO WORLD"
QString lower = str.toLower();              // "hello world"

// 去除空白
QString trimmed = "  Hello  ".trimmed();    // "Hello"
```

### 字符串分割和组合
```cpp
QString str = "Apple,Orange,Banana";

// 分割
QStringList fruits = str.split(",");        // ["Apple", "Orange", "Banana"]

// 组合
QString combined = fruits.join(";");        // "Apple;Orange;Banana"
```

## 类型转换

### 转换为数字
```cpp
QString str = "42";
bool ok;

int intVal = str.toInt(&ok);                // 42, ok = true
double dblVal = str.toDouble(&ok);          // 42.0, ok = true
float floatVal = str.toFloat(&ok);          // 42.0f, ok = true

// 指定进制
int hexVal = "FF".toInt(&ok, 16);           // 255, ok = true
```

### 转换为其他字符串类型
```cpp
QString str = "Hello 世界";

// 转换为标准字符串
std::string stdStr = str.toStdString();
std::wstring wStr = str.toStdWString();

// 转换为不同编码的字节数组
QByteArray utf8 = str.toUtf8();             // UTF-8 编码
QByteArray latin1 = str.toLatin1();         // Latin-1 编码
QByteArray local8Bit = str.toLocal8Bit();   // 本地编码

// 转换为 C 风格字符串（注意生命周期）
const char* cStr = str.toUtf8().constData();
```

## 高级功能

### 正则表达式
```cpp
QString str = "Email: john@example.com, Phone: 123-456-7890";

// 匹配
QRegularExpression emailRegex("\\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\\b", 
                             QRegularExpression::CaseInsensitiveOption);
QRegularExpressionMatch match = emailRegex.match(str);
if (match.hasMatch()) {
    QString email = match.captured(0);      // "john@example.com"
}

// 替换
QString anonymized = str;
anonymized.replace(QRegularExpression("\\d{3}-\\d{3}-\\d{4}"), "XXX-XXX-XXXX");
```

### 字符串格式化
```cpp
// 使用 arg() 进行格式化
QString name = "Alice";
int age = 25;
double score = 95.5;

QString info = QString("Name: %1, Age: %2, Score: %3%")
                .arg(name)
                .arg(age)
                .arg(score, 0, 'f', 1);  // 保留1位小数

// 结果: "Name: Alice, Age: 25, Score: 95.5%"

// 位置参数可以重复使用
QString template = "%1 loves %2. %1 is happy.";
QString sentence = template.arg("Alice").arg("Bob");
// 结果: "Alice loves Bob. Alice is happy."
```

### 国际化支持
```cpp
// 使用 tr() 进行翻译
QString translated = tr("Hello World");  // 会被翻译系统处理

// 复数形式
int n = 5;
QString message = tr("%n item(s)", "", n);  // 根据n的值选择复数形式
```

## 性能考虑

### 隐式共享机制
QString 使用隐式共享（写时复制）技术，多个字符串对象可以共享同一数据，直到需要修改时才进行复制。

```cpp
QString s1 = "Hello";      // 分配内存
QString s2 = s1;           // 共享同一数据，不复制
s2.append(" World");       // 此时才复制数据，修改s2不影响s1
```

### 高效字符串构建
对于大量字符串拼接，使用 QStringBuilder（需要包含 `<QStringBuilder>` 并启用 `QT_USE_QSTRINGBUILDER`）或预先分配空间：

```cpp
// 低效：多次重新分配
QString result;
for (int i = 0; i < 1000; ++i) {
    result += QString::number(i);
}

// 高效：预先分配空间
QString result;
result.reserve(10000);  // 预分配空间
for (int i = 0; i < 1000; ++i) {
    result += QString::number(i);
}

// 使用 QStringBuilder（更高效）
#include <QStringBuilder>
QString result;
for (int i = 0; i < 1000; ++i) {
    result %= QString::number(i) % " ";  // % 操作符用于高效连接
}
```

## 与其他 Qt 类的集成

### 与 QVariant 互转
```cpp
// QString 转 QVariant
QString str = "Hello";
QVariant var = QVariant(str);

// QVariant 转 QString
if (var.canConvert<QString>()) {
    QString str2 = var.toString();
}
```

### 与流一起使用
```cpp
// 写入字符串
QString str;
QTextStream stream(&str);
stream << "Value: " << 42 << ", PI: " << 3.14;

// 从字符串读取
QTextStream in(&str);
QString part1, part2;
int value;
double pi;
in >> part1 >> value >> part2 >> pi;
```

## 最佳实践

1. **优先使用 QString 而不是 std::string** 在 Qt 应用程序中，特别是需要处理 Unicode 或国际化的场景。

2. **使用 arg() 而不是 sprintf** 进行字符串格式化，更安全且支持本地化。

3. **避免不必要的转换** 在 Qt 生态系统内尽量保持使用 QString。

4. **注意编码转换** 在与外部系统交互时，明确指定编码格式。

5. **使用 reserve()** 当需要构建大字符串时，预先分配空间以提高性能。

QString 是 Qt 框架中极其重要的类，几乎每个 Qt 应用程序都会广泛使用它。掌握 QString 的使用对于高效开发 Qt 应用程序至关重要。